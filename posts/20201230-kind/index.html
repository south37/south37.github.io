<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>kind (Kuberenetes in Docker) に deep dive してみる | South37's Blog</title><meta name=keywords content><meta name=description content="kuKubernetes の Install Tools というページでは、kubernetes を local で動かすための tool として kind が紹介されています。今日はこの kind について内部構造及び使い方を見てみます。
kind とは kind は「Docker container の中で Kubernetes を動かすことが出来るツール」です。kind という命名は「Kubernetes in Docker」から来ていて、K-in-D という頭文字をとったものになっています。
kind については KubeCon + CloudNativeCon で何度か紹介されているようです。例えば KubeCon + CloudNativeCon North America 2019 における以下の &ldquo;Deep Dive: Kind&rdquo; というトーク では、「kind とは何か？」について内部実装など含めて紹介されています。
上記のトークについて簡単に summary を書くと、kind は以下のようなものとして紹介されています。
Docker container として Node（をシミュレートする container）を動かし、その中で Kubernetes を動かすツール Node image の中に、Kubernetes を動かすために必要な全てを詰める kubelet kubeadm docker systemd core images (Kuberentes にとって重要な container image) etcd coredns pause kube-apiserver etc."><meta name=author content="Nao Minami"><link rel=canonical href=https://www.south37.link/posts/20201230-kind/><link crossorigin=anonymous href=/assets/css/stylesheet.b183800e2cfbb62c3bce2b2ba56cdb2dd33af76c75cf4550173d5dfebd7c68a6.css integrity="sha256-sYOADiz7tiw7zisrpWzbLdM692x1z0VQFz1d/r18aKY=" rel="preload stylesheet" as=style><link rel=icon href=https://www.south37.link/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.south37.link/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.south37.link/favicon-32x32.png><link rel=apple-touch-icon href=https://www.south37.link/apple-touch-icon.png><link rel=mask-icon href=https://www.south37.link/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="kind (Kuberenetes in Docker) に deep dive してみる"><meta property="og:description" content="kuKubernetes の Install Tools というページでは、kubernetes を local で動かすための tool として kind が紹介されています。今日はこの kind について内部構造及び使い方を見てみます。
kind とは kind は「Docker container の中で Kubernetes を動かすことが出来るツール」です。kind という命名は「Kubernetes in Docker」から来ていて、K-in-D という頭文字をとったものになっています。
kind については KubeCon + CloudNativeCon で何度か紹介されているようです。例えば KubeCon + CloudNativeCon North America 2019 における以下の &ldquo;Deep Dive: Kind&rdquo; というトーク では、「kind とは何か？」について内部実装など含めて紹介されています。
上記のトークについて簡単に summary を書くと、kind は以下のようなものとして紹介されています。
Docker container として Node（をシミュレートする container）を動かし、その中で Kubernetes を動かすツール Node image の中に、Kubernetes を動かすために必要な全てを詰める kubelet kubeadm docker systemd core images (Kuberentes にとって重要な container image) etcd coredns pause kube-apiserver etc."><meta property="og:type" content="article"><meta property="og:url" content="https://www.south37.link/posts/20201230-kind/"><meta property="og:image" content="https://www.south37.link/papermod-cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-12-30T00:00:00+09:00"><meta property="article:modified_time" content="2020-12-30T00:00:00+09:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.south37.link/papermod-cover.png"><meta name=twitter:title content="kind (Kuberenetes in Docker) に deep dive してみる"><meta name=twitter:description content="kuKubernetes の Install Tools というページでは、kubernetes を local で動かすための tool として kind が紹介されています。今日はこの kind について内部構造及び使い方を見てみます。
kind とは kind は「Docker container の中で Kubernetes を動かすことが出来るツール」です。kind という命名は「Kubernetes in Docker」から来ていて、K-in-D という頭文字をとったものになっています。
kind については KubeCon + CloudNativeCon で何度か紹介されているようです。例えば KubeCon + CloudNativeCon North America 2019 における以下の &ldquo;Deep Dive: Kind&rdquo; というトーク では、「kind とは何か？」について内部実装など含めて紹介されています。
上記のトークについて簡単に summary を書くと、kind は以下のようなものとして紹介されています。
Docker container として Node（をシミュレートする container）を動かし、その中で Kubernetes を動かすツール Node image の中に、Kubernetes を動かすために必要な全てを詰める kubelet kubeadm docker systemd core images (Kuberentes にとって重要な container image) etcd coredns pause kube-apiserver etc."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.south37.link/posts/"},{"@type":"ListItem","position":2,"name":"kind (Kuberenetes in Docker) に deep dive してみる","item":"https://www.south37.link/posts/20201230-kind/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"kind (Kuberenetes in Docker) に deep dive してみる","name":"kind (Kuberenetes in Docker) に deep dive してみる","description":"kuKubernetes の Install Tools というページでは、kubernetes を local で動かすための tool として kind が紹介されています。今日はこの kind について内部構造及び使い方を見てみます。\nkind とは kind は「Docker container の中で Kubernetes を動かすことが出来るツール」です。kind という命名は「Kubernetes in Docker」から来ていて、K-in-D という頭文字をとったものになっています。\nkind については KubeCon + CloudNativeCon で何度か紹介されているようです。例えば KubeCon + CloudNativeCon North America 2019 における以下の \u0026ldquo;Deep Dive: Kind\u0026rdquo; というトーク では、「kind とは何か？」について内部実装など含めて紹介されています。\n上記のトークについて簡単に summary を書くと、kind は以下のようなものとして紹介されています。\nDocker container として Node（をシミュレートする container）を動かし、その中で Kubernetes を動かすツール Node image の中に、Kubernetes を動かすために必要な全てを詰める kubelet kubeadm docker systemd core images (Kuberentes にとって重要な container image) etcd coredns pause kube-apiserver etc.","keywords":[],"articleBody":"kuKubernetes の Install Tools というページでは、kubernetes を local で動かすための tool として kind が紹介されています。今日はこの kind について内部構造及び使い方を見てみます。\nkind とは kind は「Docker container の中で Kubernetes を動かすことが出来るツール」です。kind という命名は「Kubernetes in Docker」から来ていて、K-in-D という頭文字をとったものになっています。\nkind については KubeCon + CloudNativeCon で何度か紹介されているようです。例えば KubeCon + CloudNativeCon North America 2019 における以下の “Deep Dive: Kind” というトーク では、「kind とは何か？」について内部実装など含めて紹介されています。\n上記のトークについて簡単に summary を書くと、kind は以下のようなものとして紹介されています。\nDocker container として Node（をシミュレートする container）を動かし、その中で Kubernetes を動かすツール Node image の中に、Kubernetes を動かすために必要な全てを詰める kubelet kubeadm docker systemd core images (Kuberentes にとって重要な container image) etcd coredns pause kube-apiserver etc. multi-node 構成も可能 Kubernetes を source code から build して動かすことが可能 30s 程度で Kuberenetes cluster を作ることが出来る kind は「Kuberentes 自体の test」のために作られた Kuberenetes の CI は Kubernetes で動いており、全ての test は Pod の中で実行される。そのため、Kuberenetes 自体を test するには、「Kuberentes を container の中で動かす」必要があった。 上記のトークの中で出てくる以下のスライドが、kind の仕組みを端的に示していて分かりやすいと思います。“Node” Container の中で、kubelet や containerd, そして containered を通じて起動された「Kuberentes の動作を支える各種 container」が動いている事が分かります。\nここまでで、「kind の内部構造」を説明しました。次に、実際に kind を動かしてみましょう。\nkind を動かしてみる kind の利用方法は実はとても簡単で、README で以下のように言及されている通り「GO111MODULE=\"on\" go get sigs.k8s.io/kind@v0.9.0 \u0026\u0026 kind create cluster を実行するだけ」となっています。\nIf you have go (1.11+) and docker installed GO111MODULE=\"on\" go get sigs.k8s.io/kind@v0.9.0 \u0026\u0026 kind create cluster is all you need!\ncf. https://github.com/kubernetes-sigs/kind#please-see-our-documentation-for-more-in-depth-installation-etc\n実際に実行すると、以下のように Kubernetes cluster 作成が進みます。自分の環境では、Kuberentes cluster 作成にかかる時間は 1min 強でした。\n（なお、Ensuring node image という step で少し時間がかかりますが、これは後述する「kind が利用する kindest/node という docker image の pull に時間がかかっている」だけです。一度 image pull が完了すると次からは 30s 程度で高速に Kubernetes cluster が作成出来る様になります）。\n$ GO111MODULE=\"on\" go get sigs.k8s.io/kind@v0.9.0 \u0026\u0026 kind create cluster go: downloading sigs.k8s.io/kind v0.9.0 go: downloading github.com/spf13/cobra v1.0.0 go: downloading k8s.io/apimachinery v0.18.8 go: downloading gopkg.in/yaml.v3 v3.0.0-20200615113413-eeeca48fe776 go: downloading github.com/mattn/go-isatty v0.0.12 go: downloading github.com/alessio/shellescape v1.2.2 go: downloading sigs.k8s.io/yaml v1.2.0 go: downloading github.com/pelletier/go-toml v1.8.0 go: downloading github.com/evanphx/json-patch v0.0.0-20200808040245-162e5629780b go: downloading golang.org/x/sys v0.0.0-20200814200057-3d37ad5750ed go: downloading github.com/evanphx/json-patch/v5 v5.1.0 GO111MODULE=\"on\" go get sigs.k8s.io/kind@v0.9.0 8.93s user 3.64s system 102% cpu 12.228 total Creating cluster \"kind\" ... ✓ Ensuring node image (kindest/node:v1.19.1) 🖼 ✓ Preparing nodes 📦 ✓ Writing configuration 📜 ✓ Starting control-plane 🕹️ ✓ Installing CNI 🔌 ✓ Installing StorageClass 💾 Set kubectl context to \"kind-kind\" You can now use your cluster with: kubectl cluster-info --context kind-kind Not sure what to do next? 😅 Check out https://kind.sigs.k8s.io/docs/user/quick-start/ kind create cluster 4.95s user 2.65s system 9% cpu 1:16.71 total これで既に「Kubernetes cluster が Docker container の中で動いている状態」となっています。簡単ですね！\nkind で動く Kubernetes cluster を利用してみる 次に、実際に kind で動く Kuberentes cluster を利用してみましょう。\n$ kind create cluster を実行した際の message に Set kubectl context to \"kind-kind\" と出ていたように、既に kubectl の context は「kind で作成した Kubenetes cluster（= kind-kind という名前の cluster）」に切り替わっています。つまり、この状態で $ kubectl を利用すれば、kind-kind cluster の API server に対して通信が行われるようになっています。\n実際、以下のように $ kubectl config current-context や $ kubectl cluster-info の結果を見てみると「local で動く kind-kind cluster に context が切り替わっている」事が確認出来ます。\n$ kubectl config current-context kind-kind $ kubectl cluster-info Kubernetes control plane is running at https://127.0.0.1:55999 KubeDNS is running at https://127.0.0.1:55999/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'. $ kubectl で cluster 内の k8s object を見てみましょう。例えば namespace や pod, service を見てみると、以下のような内容になっています。\n$ kubectl get namespaces NAME STATUS AGE default Active 11m kube-node-lease Active 11m kube-public Active 11m kube-system Active 11m local-path-storage Active 11m $ kubectl get po --all-namespaces NAMESPACE NAME READY STATUS RESTARTS AGE kube-system coredns-f9fd979d6-9cgbl 1/1 Running 0 11m kube-system coredns-f9fd979d6-wlnmw 1/1 Running 0 11m kube-system etcd-kind-control-plane 1/1 Running 0 11m kube-system kindnet-phgz9 1/1 Running 0 11m kube-system kube-apiserver-kind-control-plane 1/1 Running 0 11m kube-system kube-controller-manager-kind-control-plane 1/1 Running 0 11m kube-system kube-proxy-dxx9q 1/1 Running 0 11m kube-system kube-scheduler-kind-control-plane 1/1 Running 0 11m local-path-storage local-path-provisioner-78776bfc44-66wln 1/1 Running 0 11m $ kubectl get svc --all-namespaces NAMESPACE NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE default kubernetes ClusterIP 10.96.0.1 443/TCP 18m kube-system kube-dns ClusterIP 10.96.0.10 53/UDP,53/TCP,9153/TCP 18m さらに、適当に deployment と service の追加もしてみましょう。自分が昔作った https://github.com/south37/dumper という「request header を print するだけの Docker container」を動かしてみます。\nまず、deployment と service の manifest file を用意します。\n# dumper-deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: labels: app: dumper name: dumper namespace: default spec: selector: matchLabels: app: dumper template: metadata: annotations: labels: app: dumper name: dumper spec: containers: - image: south37/dumper livenessProbe: httpGet: path: /ping port: 8080 name: dumper ports: - containerPort: 8080 name: http readinessProbe: httpGet: path: /ping port: 8080 # dumper-service.yaml apiVersion: v1 kind: Service metadata: labels: app: dumper name: dumper namespace: default spec: ports: - name: http port: 80 protocol: TCP targetPort: 8080 selector: app: dumper type: ClusterIP 次に、これらの manfest file を apply します。\n$ kubectl apply -f dumper-deployment.yaml deployment.apps/dumper created $ kubectl apply -f dumper-service.yaml service/dumper created apply したものがちゃんと作られている事を確認します。\n$ kubectl get all -n default NAME READY STATUS RESTARTS AGE pod/dumper-6465654fdc-qn729 1/1 Running 0 118s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/dumper ClusterIP 10.110.60.42 80/TCP 114s service/kubernetes ClusterIP 10.96.0.1 443/TCP 21m NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/dumper 1/1 1 1 118s NAME DESIRED CURRENT READY AGE replicaset.apps/dumper-6465654fdc 1 1 1 118s まず、pod の log を見てみます。すると、healthcheck 用の GET /ping の reqeust が来ている事が確認できます。\n$ kubectl logs dumper-6465654fdc-qn729 . . . 2020/12/30 12:09:55 GET /ping HTTP/1.1 2020/12/30 12:09:55 Host: 10.244.0.5:8080 2020/12/30 12:09:55 User-Agent: kube-probe/1.19 2020/12/30 12:09:55 Accept-Encoding: gzip 2020/12/30 12:09:55 Connection: close 次に、Kuberentes cluster の中から Service を通した request をしてみましょう。 curl が入っている docker image として radial/busyboxplus:curl を使うことにします（注: radial/busyboxplus:curl は https://kubernetes.io/docs/concepts/services-networking/connect-applications-service/ の中でも利用されてるので、安全な image だと判断して利用してます）。\nすると、以下のように Kubernetes cluster 内の pod から $ curl http://dumper.default で 「default namespace の dumper service へ HTTP request」をして、ちゃんと response が返る事を確認出来ました！\n$ kubectl run --rm -it busybox --image=radial/busyboxplus:curl If you don't see a command prompt, try pressing enter. [ root@busybox:/ ]$ curl http://dumper.default Hello, dumper! pod の log を見てみると、ちゃんと上記 request が pod に到達していることも確認できます。\n$ kubectl logs dumper-6465654fdc-qn729 . . . 2020/12/30 12:12:00 GET / HTTP/1.1 2020/12/30 12:12:00 Host: dumper.default 2020/12/30 12:12:00 User-Agent: curl/7.35.0 2020/12/30 12:12:00 Accept: */* 簡単にではありますが、Kubernetes cluster としての動作が確認できました。\nDocker container として動く Node container の中を見てみる 次に、kind の動作をもう少し深掘りしてみます。具体的には、Deep Dive: Kind - KubeCon + CloudNativeCon North America 2019 の中で紹介されていた「Node container の動作」をもう少し見てみます。\nまず、Kubernetes cluster を一度削除して作り直すことにします。これは、「作成されたばかりの状態の Kubernetes cluster」で実験するための操作です（特に気にならない人は不要です）。\n$ kind delete cluster Deleting cluster \"kind\" ... $ kind create cluster Creating cluster \"kind\" ... ✓ Ensuring node image (kindest/node:v1.19.1) 🖼 ✓ Preparing nodes 📦 ✓ Writing configuration 📜 ✓ Starting control-plane 🕹️ ✓ Installing CNI 🔌 ✓ Installing StorageClass 💾 Set kubectl context to \"kind-kind\" You can now use your cluster with: kubectl cluster-info --context kind-kind Not sure what to do next? 😅 Check out https://kind.sigs.k8s.io/docs/user/quick-start/ kind create cluster 4.62s user 2.53s system 19% cpu 36.518 total 次に、$ kind create cluster を実行した後の状態で $ docker ps すると、kindest/node:v1.19.1 という image の container が起動している事が分かります。これが、kind が利用する「Node container」のようです。\n$ docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 45a383679dd2 kindest/node:v1.19.1 \"/usr/local/bin/entr…\" About a minute ago Up 59 seconds 127.0.0.1:56856-\u003e6443/tcp kind-control-plane $ docker exec して Node container の中をみてみましょう。$ ps fax で process 一覧を見てみると、Deep Dive: Kind - KubeCon + CloudNativeCon North America 2019 の中で説明されていた通り、Kubernetes の動作を支える様々な process が起動している事が分かります。containerd や kubelet など一部を除くと、そのほかの process は /usr/local/bin/containerd-shim-runc-v2 経由で起動している（= container として起動している）ことも分かります。\n$ docker exec -it 45a383679dd2 bash root@kind-control-plane:/# ps fax PID TTY STAT TIME COMMAND 2060 pts/1 Ss 0:00 bash 2189 pts/1 R+ 0:00 \\_ ps fax 1 ? Ss 0:00 /sbin/init 124 ? S","wordCount":"2160","inLanguage":"en","datePublished":"2020-12-30T00:00:00+09:00","dateModified":"2020-12-30T00:00:00+09:00","author":{"@type":"Person","name":"Nao Minami"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.south37.link/posts/20201230-kind/"},"publisher":{"@type":"Organization","name":"South37's Blog","logo":{"@type":"ImageObject","url":"https://www.south37.link/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://www.south37.link/ accesskey=h title="South37's Blog (Alt + H)">South37's Blog</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://www.south37.link/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://www.south37.link/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.south37.link/>Home</a>&nbsp;»&nbsp;<a href=https://www.south37.link/posts/>Posts</a></div><h1 class=post-title>kind (Kuberenetes in Docker) に deep dive してみる</h1><div class=post-meta><span title='2020-12-30 00:00:00 +0900 +0900'>December 30, 2020</span>&nbsp;·&nbsp;11 min&nbsp;·&nbsp;Nao Minami</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#kindhttpsgithubcomkubernetes-sigskind-%e3%81%a8%e3%81%af aria-label="kind とは"><a href=https://github.com/kubernetes-sigs/kind>kind</a> とは</a></li><li><a href=#kindhttpsgithubcomkubernetes-sigskind-%e3%82%92%e5%8b%95%e3%81%8b%e3%81%97%e3%81%a6%e3%81%bf%e3%82%8b aria-label="kind を動かしてみる"><a href=https://github.com/kubernetes-sigs/kind>kind</a> を動かしてみる</a></li><li><a href=#kindhttpsgithubcomkubernetes-sigskind-%e3%81%a7%e5%8b%95%e3%81%8f-kubernetes-cluster-%e3%82%92%e5%88%a9%e7%94%a8%e3%81%97%e3%81%a6%e3%81%bf%e3%82%8b aria-label="kind で動く Kubernetes cluster を利用してみる"><a href=https://github.com/kubernetes-sigs/kind>kind</a> で動く Kubernetes cluster を利用してみる</a></li><li><a href=#docker-container-%e3%81%a8%e3%81%97%e3%81%a6%e5%8b%95%e3%81%8f-node-container-%e3%81%ae%e4%b8%ad%e3%82%92%e8%a6%8b%e3%81%a6%e3%81%bf%e3%82%8b aria-label="Docker container として動く Node container の中を見てみる">Docker container として動く Node container の中を見てみる</a></li><li><a href=#kindhttpsgithubcomkubernetes-sigskind-%e3%81%a8-minikubehttpsgithubcomkubernetesminikube-%e3%81%ae%e4%bd%bf%e3%81%84%e5%88%86%e3%81%91%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6 aria-label="kind と minikube の使い分けについて"><a href=https://github.com/kubernetes-sigs/kind>kind</a> と <a href=https://github.com/kubernetes/minikube>minikube</a> の使い分けについて</a></li><li><a href=#%e3%81%be%e3%81%a8%e3%82%81 aria-label=まとめ>まとめ</a></li><li><a href=#%e5%8f%82%e8%80%83%e6%83%85%e5%a0%b1 aria-label=参考情報>参考情報</a></li><li><a href=#%e3%81%8a%e3%81%be%e3%81%91-%e6%97%a2%e3%81%ab-node-image-%e3%82%92-pull-%e6%b8%88%e3%81%ae%e5%a0%b4%e5%90%88%e3%81%ab-kuberentes-cluster-%e4%bd%9c%e6%88%90%e3%81%ab%e3%81%8b%e3%81%8b%e3%82%8b%e6%99%82%e9%96%93%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6 aria-label="おまけ: 既に node image を pull 済の場合に Kuberentes cluster 作成にかかる時間について">おまけ: 既に node image を pull 済の場合に Kuberentes cluster 作成にかかる時間について</a></li><li><a href=#%e3%81%8a%e3%81%be%e3%81%91-2-deployment-%e3%82%92-apply-%e3%81%97%e3%81%9f%e7%8a%b6%e6%85%8b%e3%81%a7-node-container-%e3%81%ae%e4%b8%ad%e3%82%92%e8%a6%8b%e3%81%a6%e3%81%bf%e3%82%8b aria-label="おまけ 2: deployment を apply した状態で Node container の中を見てみる">おまけ 2: deployment を apply した状態で Node container の中を見てみる</a></li><li><a href=#%e3%81%8a%e3%81%be%e3%81%91-3--kind-load-docker-image-%e3%81%ae%e5%ae%9f%e8%a3%85%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6 aria-label="おまけ 3: $ kind load docker-image の実装について">おまけ 3: <code>$ kind load docker-image</code> の実装について</a></li></ul></div></details></div><div class=post-content><p>kuKubernetes の <a href=https://kubernetes.io/docs/tasks/tools/>Install Tools</a> というページでは、kubernetes を local で動かすための tool として <a href=https://github.com/kubernetes-sigs/kind>kind</a> が紹介されています。今日はこの <a href=https://github.com/kubernetes-sigs/kind>kind</a> について内部構造及び使い方を見てみます。</p><h2 id=kindhttpsgithubcomkubernetes-sigskind-とは><a href=https://github.com/kubernetes-sigs/kind>kind</a> とは<a hidden class=anchor aria-hidden=true href=#kindhttpsgithubcomkubernetes-sigskind-とは>#</a></h2><p>kind は「<strong>Docker container の中で Kubernetes を動かすことが出来るツール</strong>」です。kind という命名は「<strong>K</strong>ubernetes <strong>in</strong> <strong>D</strong>ocker」から来ていて、<strong>K-in-D</strong> という頭文字をとったものになっています。</p><p>kind については KubeCon + CloudNativeCon で何度か紹介されているようです。例えば <a href=https://events19.linuxfoundation.org/events/kubecon-cloudnativecon-north-america-2019/>KubeCon + CloudNativeCon North America 2019</a> における以下の <a href="https://www.youtube.com/watch?v=tT-GiZAr6eQ">&ldquo;Deep Dive: Kind&rdquo; というトーク</a> では、「kind とは何か？」について内部実装など含めて紹介されています。</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube-nocookie.com/embed/tT-GiZAr6eQ style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe></div><p>上記のトークについて簡単に summary を書くと、kind は以下のようなものとして紹介されています。</p><ul><li>Docker container として Node（をシミュレートする container）を動かし、その中で Kubernetes を動かすツール<ul><li>Node image の中に、Kubernetes を動かすために必要な全てを詰める<ul><li>kubelet</li><li>kubeadm</li><li>docker</li><li>systemd</li><li>core images (Kuberentes にとって重要な container image)<ul><li>etcd</li><li>coredns</li><li>pause</li><li>kube-apiserver</li><li>etc.</li></ul></li></ul></li></ul></li><li>multi-node 構成も可能</li><li>Kubernetes を source code から build して動かすことが可能</li><li>30s 程度で Kuberenetes cluster を作ることが出来る</li><li>kind は「Kuberentes 自体の test」のために作られた<ul><li>Kuberenetes の CI は Kubernetes で動いており、全ての test は Pod の中で実行される。そのため、Kuberenetes 自体を test するには、「Kuberentes を container の中で動かす」必要があった。</li></ul></li></ul><p>上記のトークの中で出てくる以下のスライドが、kind の仕組みを端的に示していて分かりやすいと思います。&ldquo;Node&rdquo; Container の中で、kubelet や containerd, そして containered を通じて起動された「Kuberentes の動作を支える各種 container」が動いている事が分かります。</p><p><img loading=lazy src=/images/20201230-kind/slide.webp alt="A slide in the above talk"></p><p>ここまでで、「kind の内部構造」を説明しました。次に、実際に kind を動かしてみましょう。</p><h2 id=kindhttpsgithubcomkubernetes-sigskind-を動かしてみる><a href=https://github.com/kubernetes-sigs/kind>kind</a> を動かしてみる<a hidden class=anchor aria-hidden=true href=#kindhttpsgithubcomkubernetes-sigskind-を動かしてみる>#</a></h2><p>kind の利用方法は実はとても簡単で、README で以下のように言及されている通り「<code>GO111MODULE="on" go get sigs.k8s.io/kind@v0.9.0 && kind create cluster</code> を実行するだけ」となっています。</p><blockquote><p>If you have go (1.11+) and docker installed <code>GO111MODULE="on" go get sigs.k8s.io/kind@v0.9.0 && kind create cluster</code> is all you need!</p></blockquote><p>cf. <a href=https://github.com/kubernetes-sigs/kind#please-see-our-documentation-for-more-in-depth-installation-etc>https://github.com/kubernetes-sigs/kind#please-see-our-documentation-for-more-in-depth-installation-etc</a></p><p>実際に実行すると、以下のように Kubernetes cluster 作成が進みます。自分の環境では、Kuberentes cluster 作成にかかる時間は 1min 強でした。</p><p>（なお、<code>Ensuring node image</code> という step で少し時間がかかりますが、これは後述する「kind が利用する <code>kindest/node</code> という docker image の pull に時間がかかっている」だけです。一度 image pull が完了すると次からは 30s 程度で高速に Kubernetes cluster が作成出来る様になります）。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> <span class=nv>GO111MODULE</span><span class=o>=</span><span class=s2>&#34;on&#34;</span> go get sigs.k8s.io/kind@v0.9.0 <span class=o>&amp;&amp;</span> kind create cluster
</span></span><span class=line><span class=cl><span class=go>go: downloading sigs.k8s.io/kind v0.9.0
</span></span></span><span class=line><span class=cl><span class=go>go: downloading github.com/spf13/cobra v1.0.0
</span></span></span><span class=line><span class=cl><span class=go>go: downloading k8s.io/apimachinery v0.18.8
</span></span></span><span class=line><span class=cl><span class=go>go: downloading gopkg.in/yaml.v3 v3.0.0-20200615113413-eeeca48fe776
</span></span></span><span class=line><span class=cl><span class=go>go: downloading github.com/mattn/go-isatty v0.0.12
</span></span></span><span class=line><span class=cl><span class=go>go: downloading github.com/alessio/shellescape v1.2.2
</span></span></span><span class=line><span class=cl><span class=go>go: downloading sigs.k8s.io/yaml v1.2.0
</span></span></span><span class=line><span class=cl><span class=go>go: downloading github.com/pelletier/go-toml v1.8.0
</span></span></span><span class=line><span class=cl><span class=go>go: downloading github.com/evanphx/json-patch v0.0.0-20200808040245-162e5629780b
</span></span></span><span class=line><span class=cl><span class=go>go: downloading golang.org/x/sys v0.0.0-20200814200057-3d37ad5750ed
</span></span></span><span class=line><span class=cl><span class=go>go: downloading github.com/evanphx/json-patch/v5 v5.1.0
</span></span></span><span class=line><span class=cl><span class=go>GO111MODULE=&#34;on&#34; go get sigs.k8s.io/kind@v0.9.0  8.93s user 3.64s system 102% cpu 12.228 total
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Creating cluster &#34;kind&#34; ...
</span></span></span><span class=line><span class=cl><span class=go> ✓ Ensuring node image (kindest/node:v1.19.1) 🖼
</span></span></span><span class=line><span class=cl><span class=go> ✓ Preparing nodes 📦
</span></span></span><span class=line><span class=cl><span class=go> ✓ Writing configuration 📜
</span></span></span><span class=line><span class=cl><span class=go> ✓ Starting control-plane 🕹️
</span></span></span><span class=line><span class=cl><span class=go> ✓ Installing CNI 🔌
</span></span></span><span class=line><span class=cl><span class=go> ✓ Installing StorageClass 💾
</span></span></span><span class=line><span class=cl><span class=go>Set kubectl context to &#34;kind-kind&#34;
</span></span></span><span class=line><span class=cl><span class=go>You can now use your cluster with:
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>kubectl cluster-info --context kind-kind
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Not sure what to do next? 😅  Check out https://kind.sigs.k8s.io/docs/user/quick-start/
</span></span></span><span class=line><span class=cl><span class=go>kind create cluster  4.95s user 2.65s system 9% cpu 1:16.71 total
</span></span></span></code></pre></div><p>これで既に「Kubernetes cluster が Docker container の中で動いている状態」となっています。簡単ですね！</p><h2 id=kindhttpsgithubcomkubernetes-sigskind-で動く-kubernetes-cluster-を利用してみる><a href=https://github.com/kubernetes-sigs/kind>kind</a> で動く Kubernetes cluster を利用してみる<a hidden class=anchor aria-hidden=true href=#kindhttpsgithubcomkubernetes-sigskind-で動く-kubernetes-cluster-を利用してみる>#</a></h2><p>次に、実際に kind で動く Kuberentes cluster を利用してみましょう。</p><p><code>$ kind create cluster</code> を実行した際の message に <code>Set kubectl context to "kind-kind"</code> と出ていたように、既に kubectl の context は「kind で作成した Kubenetes cluster（= <code>kind-kind</code> という名前の cluster）」に切り替わっています。つまり、この状態で <code>$ kubectl</code> を利用すれば、<code>kind-kind</code> cluster の API server に対して通信が行われるようになっています。</p><p>実際、以下のように <code>$ kubectl config current-context</code> や <code>$ kubectl cluster-info</code> の結果を見てみると「local で動く <code>kind-kind</code> cluster に context が切り替わっている」事が確認出来ます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> kubectl config current-context
</span></span><span class=line><span class=cl><span class=go>kind-kind
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> kubectl cluster-info
</span></span><span class=line><span class=cl><span class=go>Kubernetes control plane is running at https://127.0.0.1:55999
</span></span></span><span class=line><span class=cl><span class=go>KubeDNS is running at https://127.0.0.1:55999/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>To further debug and diagnose cluster problems, use &#39;kubectl cluster-info dump&#39;.
</span></span></span></code></pre></div><p><code>$ kubectl</code> で cluster 内の k8s object を見てみましょう。例えば namespace や pod, service を見てみると、以下のような内容になっています。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> kubectl get namespaces
</span></span><span class=line><span class=cl><span class=go>NAME                 STATUS   AGE
</span></span></span><span class=line><span class=cl><span class=go>default              Active   11m
</span></span></span><span class=line><span class=cl><span class=go>kube-node-lease      Active   11m
</span></span></span><span class=line><span class=cl><span class=go>kube-public          Active   11m
</span></span></span><span class=line><span class=cl><span class=go>kube-system          Active   11m
</span></span></span><span class=line><span class=cl><span class=go>local-path-storage   Active   11m
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> kubectl get po --all-namespaces
</span></span><span class=line><span class=cl><span class=go>NAMESPACE            NAME                                         READY   STATUS    RESTARTS   AGE
</span></span></span><span class=line><span class=cl><span class=go>kube-system          coredns-f9fd979d6-9cgbl                      1/1     Running   0          11m
</span></span></span><span class=line><span class=cl><span class=go>kube-system          coredns-f9fd979d6-wlnmw                      1/1     Running   0          11m
</span></span></span><span class=line><span class=cl><span class=go>kube-system          etcd-kind-control-plane                      1/1     Running   0          11m
</span></span></span><span class=line><span class=cl><span class=go>kube-system          kindnet-phgz9                                1/1     Running   0          11m
</span></span></span><span class=line><span class=cl><span class=go>kube-system          kube-apiserver-kind-control-plane            1/1     Running   0          11m
</span></span></span><span class=line><span class=cl><span class=go>kube-system          kube-controller-manager-kind-control-plane   1/1     Running   0          11m
</span></span></span><span class=line><span class=cl><span class=go>kube-system          kube-proxy-dxx9q                             1/1     Running   0          11m
</span></span></span><span class=line><span class=cl><span class=go>kube-system          kube-scheduler-kind-control-plane            1/1     Running   0          11m
</span></span></span><span class=line><span class=cl><span class=go>local-path-storage   local-path-provisioner-78776bfc44-66wln      1/1     Running   0          11m
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> kubectl get svc --all-namespaces
</span></span><span class=line><span class=cl><span class=go>NAMESPACE     NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE
</span></span></span><span class=line><span class=cl><span class=go>default       kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP                  18m
</span></span></span><span class=line><span class=cl><span class=go>kube-system   kube-dns     ClusterIP   10.96.0.10   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   18m
</span></span></span></code></pre></div><p>さらに、適当に deployment と service の追加もしてみましょう。自分が昔作った <a href=https://github.com/south37/dumper>https://github.com/south37/dumper</a> という「request header を print するだけの Docker container」を動かしてみます。</p><p>まず、deployment と service の manifest file を用意します。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># dumper-deployment.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>dumper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dumper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>dumper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>dumper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dumper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>south37/dumper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/ping</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dumper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/ping</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># dumper-service.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>dumper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dumper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>dumper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP</span><span class=w>
</span></span></span></code></pre></div><p>次に、これらの manfest file を apply します。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> kubectl apply -f dumper-deployment.yaml
</span></span><span class=line><span class=cl><span class=go>deployment.apps/dumper created
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> kubectl apply -f dumper-service.yaml
</span></span><span class=line><span class=cl><span class=go>service/dumper created
</span></span></span></code></pre></div><p>apply したものがちゃんと作られている事を確認します。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> kubectl get all -n default
</span></span><span class=line><span class=cl><span class=go>NAME                          READY   STATUS    RESTARTS   AGE
</span></span></span><span class=line><span class=cl><span class=go>pod/dumper-6465654fdc-qn729   1/1     Running   0          118s
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
</span></span></span><span class=line><span class=cl><span class=go>service/dumper       ClusterIP   10.110.60.42   &lt;none&gt;        80/TCP    114s
</span></span></span><span class=line><span class=cl><span class=go>service/kubernetes   ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP   21m
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>NAME                     READY   UP-TO-DATE   AVAILABLE   AGE
</span></span></span><span class=line><span class=cl><span class=go>deployment.apps/dumper   1/1     1            1           118s
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>NAME                                DESIRED   CURRENT   READY   AGE
</span></span></span><span class=line><span class=cl><span class=go>replicaset.apps/dumper-6465654fdc   1         1         1       118s
</span></span></span></code></pre></div><p>まず、pod の log を見てみます。すると、healthcheck 用の <code>GET /ping</code> の reqeust が来ている事が確認できます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> kubectl logs dumper-6465654fdc-qn729
</span></span><span class=line><span class=cl><span class=go>.
</span></span></span><span class=line><span class=cl><span class=go>.
</span></span></span><span class=line><span class=cl><span class=go>.
</span></span></span><span class=line><span class=cl><span class=go>2020/12/30 12:09:55 GET /ping HTTP/1.1
</span></span></span><span class=line><span class=cl><span class=go>2020/12/30 12:09:55 Host: 10.244.0.5:8080
</span></span></span><span class=line><span class=cl><span class=go>2020/12/30 12:09:55 User-Agent: kube-probe/1.19
</span></span></span><span class=line><span class=cl><span class=go>2020/12/30 12:09:55 Accept-Encoding: gzip
</span></span></span><span class=line><span class=cl><span class=go>2020/12/30 12:09:55 Connection: close
</span></span></span></code></pre></div><p>次に、Kuberentes cluster の中から Service を通した request をしてみましょう。 curl が入っている docker image として <code>radial/busyboxplus:curl</code> を使うことにします（注: <code>radial/busyboxplus:curl</code> は <a href=https://kubernetes.io/docs/concepts/services-networking/connect-applications-service/>https://kubernetes.io/docs/concepts/services-networking/connect-applications-service/</a> の中でも利用されてるので、安全な image だと判断して利用してます）。</p><p>すると、以下のように Kubernetes cluster 内の pod から <code>$ curl http://dumper.default</code> で 「<code>default</code> namespace の <code>dumper</code> service へ HTTP request」をして、ちゃんと response が返る事を確認出来ました！</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> kubectl run --rm -it busybox --image<span class=o>=</span>radial/busyboxplus:curl
</span></span><span class=line><span class=cl><span class=go>If you don&#39;t see a command prompt, try pressing enter.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=gp>[ root@busybox:/ ]$</span> curl http://dumper.default
</span></span><span class=line><span class=cl><span class=go>Hello, dumper!
</span></span></span></code></pre></div><p>pod の log を見てみると、ちゃんと上記 request が pod に到達していることも確認できます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> kubectl logs dumper-6465654fdc-qn729
</span></span><span class=line><span class=cl><span class=go>.
</span></span></span><span class=line><span class=cl><span class=go>.
</span></span></span><span class=line><span class=cl><span class=go>.
</span></span></span><span class=line><span class=cl><span class=go>2020/12/30 12:12:00 GET / HTTP/1.1
</span></span></span><span class=line><span class=cl><span class=go>2020/12/30 12:12:00 Host: dumper.default
</span></span></span><span class=line><span class=cl><span class=go>2020/12/30 12:12:00 User-Agent: curl/7.35.0
</span></span></span><span class=line><span class=cl><span class=go>2020/12/30 12:12:00 Accept: */*
</span></span></span></code></pre></div><p>簡単にではありますが、Kubernetes cluster としての動作が確認できました。</p><h2 id=docker-container-として動く-node-container-の中を見てみる>Docker container として動く Node container の中を見てみる<a hidden class=anchor aria-hidden=true href=#docker-container-として動く-node-container-の中を見てみる>#</a></h2><p>次に、kind の動作をもう少し深掘りしてみます。具体的には、<a href="https://www.youtube.com/watch?v=tT-GiZAr6eQ">Deep Dive: Kind - KubeCon + CloudNativeCon North America 2019</a> の中で紹介されていた「Node container の動作」をもう少し見てみます。</p><p>まず、Kubernetes cluster を一度削除して作り直すことにします。これは、「作成されたばかりの状態の Kubernetes cluster」で実験するための操作です（特に気にならない人は不要です）。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> kind delete cluster
</span></span><span class=line><span class=cl><span class=go>Deleting cluster &#34;kind&#34; ...
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> kind create cluster
</span></span><span class=line><span class=cl><span class=go>Creating cluster &#34;kind&#34; ...
</span></span></span><span class=line><span class=cl><span class=go> ✓ Ensuring node image (kindest/node:v1.19.1) 🖼
</span></span></span><span class=line><span class=cl><span class=go> ✓ Preparing nodes 📦
</span></span></span><span class=line><span class=cl><span class=go> ✓ Writing configuration 📜
</span></span></span><span class=line><span class=cl><span class=go> ✓ Starting control-plane 🕹️
</span></span></span><span class=line><span class=cl><span class=go> ✓ Installing CNI 🔌
</span></span></span><span class=line><span class=cl><span class=go> ✓ Installing StorageClass 💾
</span></span></span><span class=line><span class=cl><span class=go>Set kubectl context to &#34;kind-kind&#34;
</span></span></span><span class=line><span class=cl><span class=go>You can now use your cluster with:
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>kubectl cluster-info --context kind-kind
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Not sure what to do next? 😅  Check out https://kind.sigs.k8s.io/docs/user/quick-start/
</span></span></span><span class=line><span class=cl><span class=go>kind create cluster  4.62s user 2.53s system 19% cpu 36.518 total
</span></span></span></code></pre></div><p>次に、<code>$ kind create cluster</code> を実行した後の状態で <code>$ docker ps</code> すると、<code>kindest/node:v1.19.1</code> という image の container が起動している事が分かります。これが、kind が利用する「Node container」のようです。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> docker ps
</span></span><span class=line><span class=cl><span class=go>CONTAINER ID   IMAGE                  COMMAND                  CREATED              STATUS          PORTS                       NAMES
</span></span></span><span class=line><span class=cl><span class=go>45a383679dd2   kindest/node:v1.19.1   &#34;/usr/local/bin/entr…&#34;   About a minute ago   Up 59 seconds   127.0.0.1:56856-&gt;6443/tcp   kind-control-plane
</span></span></span></code></pre></div><p><code>$ docker exec</code> して Node container の中をみてみましょう。<code>$ ps fax</code> で process 一覧を見てみると、<a href="https://www.youtube.com/watch?v=tT-GiZAr6eQ">Deep Dive: Kind - KubeCon + CloudNativeCon North America 2019</a> の中で説明されていた通り、Kubernetes の動作を支える様々な process が起動している事が分かります。<code>containerd</code> や <code>kubelet</code> など一部を除くと、そのほかの process は <code>/usr/local/bin/containerd-shim-runc-v2</code> 経由で起動している（= container として起動している）ことも分かります。</p><pre tabindex=0><code>$ docker exec -it 45a383679dd2 bash
root@kind-control-plane:/# ps fax
    PID TTY      STAT   TIME COMMAND
   2060 pts/1    Ss     0:00 bash
   2189 pts/1    R+     0:00  \_ ps fax
      1 ?        Ss     0:00 /sbin/init
    124 ?        S&lt;s    0:00 /lib/systemd/systemd-journald
    135 ?        Ssl    0:11 /usr/local/bin/containerd
    310 ?        Sl     0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 1c426469eb3ae09b744f1c116e6798c65886e218271dfa105fba747b4bfde0d3 -address /run/containerd/containerd.soc
    405 ?        Ss     0:00  \_ /pause
    502 ?        Ssl    0:06  \_ kube-scheduler --authentication-kubeconfig=/etc/kubernetes/scheduler.conf --authorization-kubeconfig=/etc/kubernetes/scheduler.conf --bind-address=127.0.0.1 --ku
    311 ?        Sl     0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 23d54713b4401fb309725273c78961ea5d7f3a5be157d2a139813b9b9611e220 -address /run/containerd/containerd.soc
    418 ?        Ss     0:00  \_ /pause
    620 ?        Ssl    0:20  \_ etcd --advertise-client-urls=https://172.19.0.2:2379 --cert-file=/etc/kubernetes/pki/etcd/server.crt --client-cert-auth=true --data-dir=/var/lib/etcd --initial-a
    318 ?        Sl     0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id a24a84c14111721de85b657f2bb0b89db44d87e97452ef86690060a0f0fcd3bc -address /run/containerd/containerd.soc
    425 ?        Ss     0:00  \_ /pause
    563 ?        Ssl    1:08  \_ kube-apiserver --advertise-address=172.19.0.2 --allow-privileged=true --authorization-mode=Node,RBAC --client-ca-file=/etc/kubernetes/pki/ca.crt --enable-admissi
    373 ?        Sl     0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 8a6a56e83a590f4958dbd3262e4b0adbe36acad229ebcb54ef13c657f39c2c0a -address /run/containerd/containerd.soc
    433 ?        Ss     0:00  \_ /pause
    548 ?        Ssl    0:24  \_ kube-controller-manager --allocate-node-cidrs=true --authentication-kubeconfig=/etc/kubernetes/controller-manager.conf --authorization-kubeconfig=/etc/kubernetes
    667 ?        Ssl    0:25 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/kubelet/config.yaml --cont
    797 ?        Sl     0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 841020b0c947c1a8c2047a542268bf3dd91f8fb6b15cfc0a993dc61c0769e660 -address /run/containerd/containerd.soc
    819 ?        Ss     0:00  \_ /pause
    898 ?        Ssl    0:00  \_ /usr/local/bin/kube-proxy --config=/var/lib/kube-proxy/config.conf --hostname-override=kind-control-plane
    833 ?        Sl     0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 6171f628b9c0658a1983b198160fe76b53eeb4118aa8a0c71491ff5516453268 -address /run/containerd/containerd.soc
    864 ?        Ss     0:00  \_ /pause
    948 ?        Ssl    0:00  \_ /bin/kindnetd
   1110 ?        Sl     0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 1fd32fb832a5e3782d1f39b26b99a30de8872a0a69600a77db3631f274eeb819 -address /run/containerd/containerd.soc
   1153 ?        Ss     0:00  \_ /pause
   1226 ?        Ssl    0:03  \_ /coredns -conf /etc/coredns/Corefile
   1112 ?        Sl     0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 725b634f7fc5d93ebfb1e63afb8aabcd936e6297ed7ab552e314e1cc90efeec5 -address /run/containerd/containerd.soc
   1160 ?        Ss     0:00  \_ /pause
   1229 ?        Ssl    0:01  \_ local-path-provisioner --debug start --helper-image k8s.gcr.io/build-image/debian-base:v2.1.0 --config /etc/config/config.json
   1350 ?        Sl     0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 9d07db434b356d9fddb2ae31715adc1209406a604b7068560f379832f5d79ba2 -address /run/containerd/containerd.soc
   1373 ?        Ss     0:00  \_ /pause
   1404 ?        Ssl    0:03  \_ /coredns -conf /etc/coredns/Corefile
</code></pre><p>containerd で起動している container は、containerd の CLI tool である <code>ctr</code> で管理する事が出来るはずです。少し見てみましょう。</p><p>まず、namespace 一覧を見てみると <code>k8s.io</code> という名前の namespace が見つかります（注: この namespace は kuberentes の namespace とは無関係で、「containerd が container を管理する際に利用する namespace 機能」のはずです）。</p><pre tabindex=0><code>root@kind-control-plane:/# ctr namespaces ls
NAME   LABELS
k8s.io
</code></pre><p>次に、この <code>k8s.io</code> namespace 内の container 一覧を <code>$ ctr --namespace k8s.io containers ls</code> で見てみると、予想通り「Kuberentes cluster の動作に利用される container 一覧」をみる事が出来ました。</p><pre tabindex=0><code>root@kind-control-plane:/# ctr --namespace k8s.io containers ls
CONTAINER                                                           IMAGE                                                                      RUNTIME
0e7fc11f71638b86f8fd41f046101ebcb16b48976f06826add2d35df4e2ccc10    k8s.gcr.io/kube-controller-manager:v1.19.1                                 io.containerd.runc.v2
114d8f7f34ebc00c00236d7a111961193a6fa300dc90a4114385134f9eeda412    k8s.gcr.io/kube-proxy:v1.19.1                                              io.containerd.runc.v2
1c426469eb3ae09b744f1c116e6798c65886e218271dfa105fba747b4bfde0d3    k8s.gcr.io/pause:3.3                                                       io.containerd.runc.v2
1fd32fb832a5e3782d1f39b26b99a30de8872a0a69600a77db3631f274eeb819    k8s.gcr.io/pause:3.3                                                       io.containerd.runc.v2
2299e2a7b2b7afbb0789b30a4d7f4e57220a650f7368c04439e91c72e5049356    k8s.gcr.io/kube-apiserver:v1.19.1                                          io.containerd.runc.v2
23d54713b4401fb309725273c78961ea5d7f3a5be157d2a139813b9b9611e220    k8s.gcr.io/pause:3.3                                                       io.containerd.runc.v2
35ab22ae753e043553188810bddfec43aa048d8c93f1ca38cf868ee31dbe06fc    k8s.gcr.io/coredns:1.7.0                                                   io.containerd.runc.v2
6171f628b9c0658a1983b198160fe76b53eeb4118aa8a0c71491ff5516453268    k8s.gcr.io/pause:3.3                                                       io.containerd.runc.v2
6212a3ea51397a8491a8defb188faa1c9afb4b678a8fa102ab15ba8c78f98aa2    sha256:0369cf4303ffdb467dc219990960a9baa8512a54b0ad9283eaf55bd6c0adb934    io.containerd.runc.v2
624a9cf197014dcdbf0be5ddd68995566d14ceab00c8ca18fd51eb35cfe999cb    k8s.gcr.io/kube-scheduler:v1.19.1                                          io.containerd.runc.v2
62d494fe1a94a396494ecd30cfa8538db2e1d2055fedac216d19fd21332d3841    sha256:b77790820d01598b2c56f823fa489e3f56be2cb5d6f7dd9eecd68a1995b89c13    io.containerd.runc.v2
725b634f7fc5d93ebfb1e63afb8aabcd936e6297ed7ab552e314e1cc90efeec5    k8s.gcr.io/pause:3.3                                                       io.containerd.runc.v2
841020b0c947c1a8c2047a542268bf3dd91f8fb6b15cfc0a993dc61c0769e660    k8s.gcr.io/pause:3.3                                                       io.containerd.runc.v2
8a6a56e83a590f4958dbd3262e4b0adbe36acad229ebcb54ef13c657f39c2c0a    k8s.gcr.io/pause:3.3                                                       io.containerd.runc.v2
9d07db434b356d9fddb2ae31715adc1209406a604b7068560f379832f5d79ba2    k8s.gcr.io/pause:3.3                                                       io.containerd.runc.v2
a24a84c14111721de85b657f2bb0b89db44d87e97452ef86690060a0f0fcd3bc    k8s.gcr.io/pause:3.3                                                       io.containerd.runc.v2
b7775d2582ea9fdd481cf308d9c8bafa28fffbdaa2c8c0bad3377a9254876a59    k8s.gcr.io/coredns:1.7.0                                                   io.containerd.runc.v2
ecbad3d6f6f5321e46b0d3ac395cb25227b42cfc04b1cec5a2b659fe45fab6cc    sha256:e422121c9c5f97623245b7e600eeb5e223ee623f21fa04da985ae71057d8d70b    io.containerd.runc.v2
</code></pre><p>このように、「Node container の中で containerd を動かし、その containerd 経由で Kuberentes cluster に必要な container を動かす」という形で kind は動作するようです。<a href="https://www.youtube.com/watch?v=tT-GiZAr6eQ">Deep Dive: Kind - KubeCon + CloudNativeCon North America 2019</a> の中で説明されていた事ではありますが、改めてその動作を確認できました。</p><h2 id=kindhttpsgithubcomkubernetes-sigskind-と-minikubehttpsgithubcomkubernetesminikube-の使い分けについて><a href=https://github.com/kubernetes-sigs/kind>kind</a> と <a href=https://github.com/kubernetes/minikube>minikube</a> の使い分けについて<a hidden class=anchor aria-hidden=true href=#kindhttpsgithubcomkubernetes-sigskind-と-minikubehttpsgithubcomkubernetesminikube-の使い分けについて>#</a></h2><p>さて、ここまでは <a href=https://github.com/kubernetes-sigs/kind>kind</a> というツールの機能について説明してきました。一方で、「local で Kubernetes を動かすツール」としては他に <a href=https://github.com/kubernetes/minikube>minikube</a> も存在します。これらの使い分けはどうするのが良いでしょうか？</p><p><code>kind vs minikube</code> で検索すると、この2つの使い分けについて言及している記事がいくつか見つかります。例えば <a href=https://brennerm.github.io/posts/minikube-vs-kind-vs-k3s.html>https://brennerm.github.io/posts/minikube-vs-kind-vs-k3s.html</a> という記事では、以下のようにそれぞれの特徴が述べられています。</p><ul><li><a href=https://github.com/kubernetes/minikube>minikube</a><ol><li>VM で Kubernetes を起動する</li><li><code>$ minikube dashboard</code> 機能や <a href=https://minikube.sigs.k8s.io/docs/handbook/deploying/>minikube の addon system</a> が有用</li></ol></li><li><a href=https://github.com/kubernetes-sigs/kind>kind</a><ol><li>Docker container で Kubernetes を起動する</li><li><code>$ kind load docker-image &lt;my-custom-image>:&lt;tag></code> を実行する事で <strong>local で build した image を container registry へ push する事なく Kubernetes cluster から利用する事が可能</strong></li></ol></li></ul><p>kind について言えば、<code>$ kind load docker-image</code> の機能はかなり強力で、例えば custom controller のような「Kubernetes の中で動かしながら開発を進めたいもの」においては極めて有用です。実際、こういった側面があるためか、<a href=https://book.kubebuilder.io/quick-start.html#test-it-out>kubebuilder の Tutorial の Quick Start</a> では「local で Kuberentes cluster を動かす選択肢」として kind が紹介されていたりします。</p><blockquote><p>You’ll need a Kubernetes cluster to run against. You can use KIND to get a local cluster for testing, or run against a remote cluster.</p></blockquote><p>cf. <a href=https://book.kubebuilder.io/quick-start.html#test-it-out>https://book.kubebuilder.io/quick-start.html#test-it-out</a></p><p>また、「VM よりも Docker container の方が扱いに慣れてる」などのケースでも kind の利用にはメリットがありそうだと個人的には感じました。</p><h2 id=まとめ>まとめ<a hidden class=anchor aria-hidden=true href=#まとめ>#</a></h2><p><a href=https://github.com/kubernetes-sigs/kind>kind</a> の内部構造や使い方についてざっと眺めてみました。</p><p>「Kuberentes を Docker container の中で動かす」という言葉だけを聞くと突拍子も無いアイディアに聞こえますが、<code>kubelet</code> や <code>containerd</code>, その他の Kubernetes cluster に必要な component を &ldquo;Node&rdquo; image の中にまとめて配布してると思えば確かに自然ですし、実際にちゃんと動作することも確認できました。</p><p>Kuberentes の CI で使われている限り、これからも継続してメンテナンスされていきそうなのも良い点です。「30s で Kubernetes cluster を起動して気軽に動かせるツール」として、とても有用なものだと言えそうです。</p><p>なお、今回は「kind の Node container で動く container 一覧を眺めた」だけで、1つ1つの container の動きについては特に言及しませんでした。そのほとんどは「Kubernetes cluster に共通で必要な component」のはずですが、<code>kindnetd</code> は kind におけるデフォルトの CNI plugin である <a href=https://github.com/aojea/kindnet>kindnet</a> の daemon だそうです。</p><p><a href="https://www.youtube.com/watch?v=tT-GiZAr6eQ">Deep Dive: Kind - KubeCon + CloudNativeCon North America 2019</a> ではこの <a href=https://github.com/aojea/kindnet>kindnet</a> を含めて、このブログで言及してない様々な事を説明してるので、さらに詳細が気になる方はぜひ動画の方もみてみてください。また、自分も一部しか読んでませんが、kind の document (<a href=https://kind.sigs.k8s.io/>https://kind.sigs.k8s.io/</a>) も理解を深める上でとても有用だと思います。</p><h2 id=参考情報>参考情報<a hidden class=anchor aria-hidden=true href=#参考情報>#</a></h2><ul><li>Kubernetes tools: <a href=https://kubernetes.io/docs/tasks/tools/>https://kubernetes.io/docs/tasks/tools/</a></li><li>kind: <a href=https://github.com/kubernetes-sigs/kind>https://github.com/kubernetes-sigs/kind</a></li><li>kind quick start: <a href=https://kind.sigs.k8s.io/docs/user/quick-start>https://kind.sigs.k8s.io/docs/user/quick-start</a></li><li>Deep Dive: Kind - KubeCon + CloudNativeCon North America 2019: <a href="https://www.youtube.com/watch?v=tT-GiZAr6eQ">https://www.youtube.com/watch?v=tT-GiZAr6eQ</a></li></ul><h2 id=おまけ-既に-node-image-を-pull-済の場合に-kuberentes-cluster-作成にかかる時間について>おまけ: 既に node image を pull 済の場合に Kuberentes cluster 作成にかかる時間について<a hidden class=anchor aria-hidden=true href=#おまけ-既に-node-image-を-pull-済の場合に-kuberentes-cluster-作成にかかる時間について>#</a></h2><p>最初に kind を動かしてみた際に、「<code>kindest/node</code> の docker pull 部分で時間がかかる」と書きました。そこで、「既に node image を pull 済みの場合」についても、試しに計測してみましょう。</p><p>まず、先ほど作成した cluster を削除します。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> kind delete cluster
</span></span><span class=line><span class=cl><span class=go>Deleting cluster &#34;kind&#34; ...
</span></span></span></code></pre></div><p>この状態でも、<code>kindest/node</code> docker image は残っている事が確認できます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> docker images <span class=p>|</span> grep kindest
</span></span><span class=line><span class=cl><span class=go>kindest/node                      &lt;none&gt;               37ddbc9063d2   3 months ago    1.33GB
</span></span></span></code></pre></div><p>次に、この状態で再度 <code>$ kind create cluster</code> を実行してみます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> kind create cluster
</span></span><span class=line><span class=cl><span class=go>Creating cluster &#34;kind&#34; ...
</span></span></span><span class=line><span class=cl><span class=go> ✓ Ensuring node image (kindest/node:v1.19.1) 🖼
</span></span></span><span class=line><span class=cl><span class=go> ✓ Preparing nodes 📦
</span></span></span><span class=line><span class=cl><span class=go> ✓ Writing configuration 📜
</span></span></span><span class=line><span class=cl><span class=go> ✓ Starting control-plane 🕹️
</span></span></span><span class=line><span class=cl><span class=go> ✓ Installing CNI 🔌
</span></span></span><span class=line><span class=cl><span class=go> ✓ Installing StorageClass 💾
</span></span></span><span class=line><span class=cl><span class=go>Set kubectl context to &#34;kind-kind&#34;
</span></span></span><span class=line><span class=cl><span class=go>You can now use your cluster with:
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>kubectl cluster-info --context kind-kind
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Have a nice day! 👋
</span></span></span><span class=line><span class=cl><span class=go>kind create cluster  4.53s user 2.37s system 21% cpu 32.535 total
</span></span></span></code></pre></div><p>今回は、上記のように 30s 程度で Kubernetes cluster が起動することを確認できました！🎉 Node image の pull が無ければ、Kuberentes cluster をとても素早く作成出来る事が分かりますね！</p><h2 id=おまけ-2-deployment-を-apply-した状態で-node-container-の中を見てみる>おまけ 2: deployment を apply した状態で Node container の中を見てみる<a hidden class=anchor aria-hidden=true href=#おまけ-2-deployment-を-apply-した状態で-node-container-の中を見てみる>#</a></h2><p>deployment を apply した状態で、Node container の中を見てみましょう。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> kubectl apply -f dumper-deployment.yaml
</span></span><span class=line><span class=cl><span class=go>deployment.apps/dumper created
</span></span></span></code></pre></div><p>この状態だと、（当然ではありますが）apply した内容の pod に相当する container が起動している様子を確認できます。containerd の動作を感じる事が出来て、とても良いですね！</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> docker <span class=nb>exec</span> -it 7ff1d05ef709 bash
</span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>root@kind-control-plane:/# ps fax
</span></span></span><span class=line><span class=cl><span class=go>    PID TTY      STAT   TIME COMMAND
</span></span></span><span class=line><span class=cl><span class=go>.
</span></span></span><span class=line><span class=cl><span class=go>.
</span></span></span><span class=line><span class=cl><span class=go>.
</span></span></span><span class=line><span class=cl><span class=go>   1729 ?        Sl     0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 34794c98df201080b5b22bcef08805e03748023c35f0deec77f962ff301a6835 -address /run/containerd/containerd.sock
</span></span></span><span class=line><span class=cl><span class=go>   1752 ?        Ss     0:00  \_ /pause
</span></span></span><span class=line><span class=cl><span class=go>   1879 ?        Ssl    0:00  \_ /app/dumper
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>root@kind-control-plane:/# ctr --namespace k8s.io images ls | grep dumper
</span></span></span><span class=line><span class=cl><span class=go>docker.io/south37/dumper:latest                                                                  application/vnd.docker.distribution.manifest.v2+json sha256:5efcf15fbd3439b2c2fff2415957933b45b9531401526c026c41219aed15701c 290.0 MiB linux/amd64 io.cri-containerd.image=managed
</span></span></span><span class=line><span class=cl><span class=go>docker.io/south37/dumper@sha256:5efcf15fbd3439b2c2fff2415957933b45b9531401526c026c41219aed15701c application/vnd.docker.distribution.manifest.v2+json sha256:5efcf15fbd3439b2c2fff2415957933b45b9531401526c026c41219aed15701c 290.0 MiB linux/amd64 io.cri-containerd.image=managed
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>root@kind-control-plane:/# ctr --namespace k8s.io containers ls | grep dumper
</span></span></span><span class=line><span class=cl><span class=go>ab80cafc653433c2b74713b85679797b4ffad5ae54eed733bb40d41af7bb9f43    docker.io/south37/dumper:latest                                            io.containerd.runc.v2
</span></span></span></code></pre></div><h2 id=おまけ-3--kind-load-docker-image-の実装について>おまけ 3: <code>$ kind load docker-image</code> の実装について<a hidden class=anchor aria-hidden=true href=#おまけ-3--kind-load-docker-image-の実装について>#</a></h2><p>kind の強力な機能である <code>$ kind load docker-image</code> 機能がどう実現されているのか気になったので、少しコードを読んでみました（対象は kind の <code>v0.9.0</code> tag のコードです）。</p><p>まず、<code>$ kind load</code> コマンド自体は <a href=https://github.com/kubernetes-sigs/kind/blob/v0.9.0/pkg/cmd/kind/load/load.go>https://github.com/kubernetes-sigs/kind/blob/v0.9.0/pkg/cmd/kind/load/load.go</a> で実装されていて、その中の <code>$ kind load docker-image</code> サブコマンドは <a href=https://github.com/kubernetes-sigs/kind/blob/v0.9.0/pkg/cmd/kind/load/docker-image/docker-image.go>https://github.com/kubernetes-sigs/kind/blob/v0.9.0/pkg/cmd/kind/load/docker-image/docker-image.go</a> で実装されてるようです。さらにコードを読み進めると、<code>nodeutils</code> package の <code>LoadImageArchive</code> という関数にたどり着きます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=nx>dockerimage</span> <span class=s>&#34;sigs.k8s.io/kind/pkg/cmd/kind/load/docker-image&#34;</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// NewCommand returns a new cobra.Command for get
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>NewCommand</span><span class=p>(</span><span class=nx>logger</span> <span class=nx>log</span><span class=p>.</span><span class=nx>Logger</span><span class=p>,</span> <span class=nx>streams</span> <span class=nx>cmd</span><span class=p>.</span><span class=nx>IOStreams</span><span class=p>)</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>cmd</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Args</span><span class=p>:</span>  <span class=nx>cobra</span><span class=p>.</span><span class=nx>NoArgs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Use</span><span class=p>:</span>   <span class=s>&#34;load&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Short</span><span class=p>:</span> <span class=s>&#34;Loads images into nodes&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Long</span><span class=p>:</span>  <span class=s>&#34;Loads images into node from an archive or image on host&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// add subcommands
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cmd</span><span class=p>.</span><span class=nf>AddCommand</span><span class=p>(</span><span class=nx>dockerimage</span><span class=p>.</span><span class=nf>NewCommand</span><span class=p>(</span><span class=nx>logger</span><span class=p>,</span> <span class=nx>streams</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nx>cmd</span><span class=p>.</span><span class=nf>AddCommand</span><span class=p>(</span><span class=nx>imagearchive</span><span class=p>.</span><span class=nf>NewCommand</span><span class=p>(</span><span class=nx>logger</span><span class=p>,</span> <span class=nx>streams</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>cmd</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>cf. <a href=https://github.com/kubernetes-sigs/kind/blob/v0.9.0/pkg/cmd/kind/load/load.go#L38>https://github.com/kubernetes-sigs/kind/blob/v0.9.0/pkg/cmd/kind/load/load.go#L38</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>	<span class=c1>// Load the image on the selected nodes
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>fns</span> <span class=o>:=</span> <span class=p>[]</span><span class=kd>func</span><span class=p>()</span> <span class=kt>error</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>selectedNode</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>selectedNodes</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>selectedNode</span> <span class=o>:=</span> <span class=nx>selectedNode</span> <span class=c1>// capture loop variable
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>fns</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>fns</span><span class=p>,</span> <span class=kd>func</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nf>loadImage</span><span class=p>(</span><span class=nx>imageTarPath</span><span class=p>,</span> <span class=nx>selectedNode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span></code></pre></div><p>cf. <a href=https://github.com/kubernetes-sigs/kind/blob/v0.9.0/pkg/cmd/kind/load/docker-image/docker-image.go#L149-L156>https://github.com/kubernetes-sigs/kind/blob/v0.9.0/pkg/cmd/kind/load/docker-image/docker-image.go#L149-L156</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// loads an image tarball onto a node
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>loadImage</span><span class=p>(</span><span class=nx>imageTarName</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>node</span> <span class=nx>nodes</span><span class=p>.</span><span class=nx>Node</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>f</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>imageTarName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>Wrap</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;failed to open image&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>nodeutils</span><span class=p>.</span><span class=nf>LoadImageArchive</span><span class=p>(</span><span class=nx>node</span><span class=p>,</span> <span class=nx>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>cf. <a href=https://github.com/kubernetes-sigs/kind/blob/v0.9.0/pkg/cmd/kind/load/docker-image/docker-image.go#L162-L170>https://github.com/kubernetes-sigs/kind/blob/v0.9.0/pkg/cmd/kind/load/docker-image/docker-image.go#L162-L170</a></p><p><code>nodeutils.LoadImageArchive</code> は以下のような実装になっていて、「Node container の中で <code>$ ctr</code> コマンドを呼び出して、container image の load を行う」ようです。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// LoadImageArchive loads image onto the node, where image is a Reader over an image archive
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>LoadImageArchive</span><span class=p>(</span><span class=nx>n</span> <span class=nx>nodes</span><span class=p>.</span><span class=nx>Node</span><span class=p>,</span> <span class=nx>image</span> <span class=nx>io</span><span class=p>.</span><span class=nx>Reader</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>cmd</span> <span class=o>:=</span> <span class=nx>n</span><span class=p>.</span><span class=nf>Command</span><span class=p>(</span><span class=s>&#34;ctr&#34;</span><span class=p>,</span> <span class=s>&#34;--namespace=k8s.io&#34;</span><span class=p>,</span> <span class=s>&#34;images&#34;</span><span class=p>,</span> <span class=s>&#34;import&#34;</span><span class=p>,</span> <span class=s>&#34;-&#34;</span><span class=p>).</span><span class=nf>SetStdin</span><span class=p>(</span><span class=nx>image</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>cmd</span><span class=p>.</span><span class=nf>Run</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>Wrap</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;failed to load image&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>cf. <a href=https://github.com/kubernetes-sigs/kind/blob/v0.9.0/pkg/cluster/nodeutils/util.go#L77-L84>https://github.com/kubernetes-sigs/kind/blob/v0.9.0/pkg/cluster/nodeutils/util.go#L77-L84</a></p><p><code>nodeutils.LoadImageArchive</code> は「1 つ 1 つの Node container に対して loop を回して実行してる」ようです。つまり、魔法のように見えた <code>$ kind load docker-image</code> の機能は、「それぞれの Node container の中で <code>$ ctr images import</code> を実行して、container image を import する」事で実現しているようです。面白いですね！</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://www.south37.link/posts/20210228-chromium-with-mold/><span class=title>« Prev</span><br><span>mold と呼ばれる高速なリンカを利用して Chromium を Build してみる</span></a>
<a class=next href=https://www.south37.link/posts/20201228-bigquery/><span class=title>Next »</span><br><span>BigQuery の内部実装の変遷について</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share kind (Kuberenetes in Docker) に deep dive してみる on twitter" href="https://twitter.com/intent/tweet/?text=kind%20%28Kuberenetes%20in%20Docker%29%20%e3%81%ab%20deep%20dive%20%e3%81%97%e3%81%a6%e3%81%bf%e3%82%8b&url=https%3a%2f%2fwww.south37.link%2fposts%2f20201230-kind%2f&hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share kind (Kuberenetes in Docker) に deep dive してみる on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.south37.link%2fposts%2f20201230-kind%2f&title=kind%20%28Kuberenetes%20in%20Docker%29%20%e3%81%ab%20deep%20dive%20%e3%81%97%e3%81%a6%e3%81%bf%e3%82%8b&summary=kind%20%28Kuberenetes%20in%20Docker%29%20%e3%81%ab%20deep%20dive%20%e3%81%97%e3%81%a6%e3%81%bf%e3%82%8b&source=https%3a%2f%2fwww.south37.link%2fposts%2f20201230-kind%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share kind (Kuberenetes in Docker) に deep dive してみる on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.south37.link%2fposts%2f20201230-kind%2f&title=kind%20%28Kuberenetes%20in%20Docker%29%20%e3%81%ab%20deep%20dive%20%e3%81%97%e3%81%a6%e3%81%bf%e3%82%8b"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share kind (Kuberenetes in Docker) に deep dive してみる on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.south37.link%2fposts%2f20201230-kind%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share kind (Kuberenetes in Docker) に deep dive してみる on whatsapp" href="https://api.whatsapp.com/send?text=kind%20%28Kuberenetes%20in%20Docker%29%20%e3%81%ab%20deep%20dive%20%e3%81%97%e3%81%a6%e3%81%bf%e3%82%8b%20-%20https%3a%2f%2fwww.south37.link%2fposts%2f20201230-kind%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share kind (Kuberenetes in Docker) に deep dive してみる on telegram" href="https://telegram.me/share/url?text=kind%20%28Kuberenetes%20in%20Docker%29%20%e3%81%ab%20deep%20dive%20%e3%81%97%e3%81%a6%e3%81%bf%e3%82%8b&url=https%3a%2f%2fwww.south37.link%2fposts%2f20201230-kind%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://www.south37.link/>South37's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>