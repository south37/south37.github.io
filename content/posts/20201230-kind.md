---
title: "kind (Kuberenetes in Docker) ã« deep dive ã—ã¦ã¿ã‚‹"
date: 2020-12-30T00:00:00+09:00
draft: false
---

kuKubernetes ã® [Install Tools](https://kubernetes.io/docs/tasks/tools/) ã¨ã„ã†ãƒšãƒ¼ã‚¸ã§ã¯ã€kubernetes ã‚’ local ã§å‹•ã‹ã™ãŸã‚ã® tool ã¨ã—ã¦ [kind](https://github.com/kubernetes-sigs/kind) ãŒç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ã€‚ä»Šæ—¥ã¯ã“ã® [kind](https://github.com/kubernetes-sigs/kind) ã«ã¤ã„ã¦å†…éƒ¨æ§‹é€ åŠã³ä½¿ã„æ–¹ã‚’è¦‹ã¦ã¿ã¾ã™ã€‚

## [kind](https://github.com/kubernetes-sigs/kind) ã¨ã¯

kind ã¯ã€Œ**Docker container ã®ä¸­ã§ Kubernetes ã‚’å‹•ã‹ã™ã“ã¨ãŒå‡ºæ¥ã‚‹ãƒ„ãƒ¼ãƒ«**ã€ã§ã™ã€‚kind ã¨ã„ã†å‘½åã¯ã€Œ**K**ubernetes **in** **D**ockerã€ã‹ã‚‰æ¥ã¦ã„ã¦ã€**K-in-D** ã¨ã„ã†é ­æ–‡å­—ã‚’ã¨ã£ãŸã‚‚ã®ã«ãªã£ã¦ã„ã¾ã™ã€‚

kind ã«ã¤ã„ã¦ã¯ KubeCon + CloudNativeCon ã§ä½•åº¦ã‹ç´¹ä»‹ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚ä¾‹ãˆã° [KubeCon + CloudNativeCon North America 2019](https://events19.linuxfoundation.org/events/kubecon-cloudnativecon-north-america-2019/) ã«ãŠã‘ã‚‹ä»¥ä¸‹ã® ["Deep Dive: Kind" ã¨ã„ã†ãƒˆãƒ¼ã‚¯](https://www.youtube.com/watch?v=tT-GiZAr6eQ) ã§ã¯ã€ã€Œkind ã¨ã¯ä½•ã‹ï¼Ÿã€ã«ã¤ã„ã¦å†…éƒ¨å®Ÿè£…ãªã©å«ã‚ã¦ç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ã€‚

{{< youtube tT-GiZAr6eQ >}}

ä¸Šè¨˜ã®ãƒˆãƒ¼ã‚¯ã«ã¤ã„ã¦ç°¡å˜ã« summary ã‚’æ›¸ãã¨ã€kind ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚‚ã®ã¨ã—ã¦ç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ã€‚

- Docker container ã¨ã—ã¦ Nodeï¼ˆã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã™ã‚‹ containerï¼‰ã‚’å‹•ã‹ã—ã€ãã®ä¸­ã§ Kubernetes ã‚’å‹•ã‹ã™ãƒ„ãƒ¼ãƒ«
	- Node image ã®ä¸­ã«ã€Kubernetes ã‚’å‹•ã‹ã™ãŸã‚ã«å¿…è¦ãªå…¨ã¦ã‚’è©°ã‚ã‚‹
		- kubelet
		- kubeadm
		- docker
		- systemd
		- core images (Kuberentes ã«ã¨ã£ã¦é‡è¦ãª container image)
			- etcd
			- coredns
			- pause
			- kube-apiserver
			- etc.
- multi-node æ§‹æˆã‚‚å¯èƒ½
- Kubernetes ã‚’ source code ã‹ã‚‰ build ã—ã¦å‹•ã‹ã™ã“ã¨ãŒå¯èƒ½
- 30s ç¨‹åº¦ã§ Kuberenetes cluster ã‚’ä½œã‚‹ã“ã¨ãŒå‡ºæ¥ã‚‹
- kind ã¯ã€ŒKuberentes è‡ªä½“ã® testã€ã®ãŸã‚ã«ä½œã‚‰ã‚ŒãŸ
	- Kuberenetes ã® CI ã¯ Kubernetes ã§å‹•ã„ã¦ãŠã‚Šã€å…¨ã¦ã® test ã¯ Pod ã®ä¸­ã§å®Ÿè¡Œã•ã‚Œã‚‹ã€‚ãã®ãŸã‚ã€Kuberenetes è‡ªä½“ã‚’ test ã™ã‚‹ã«ã¯ã€ã€ŒKuberentes ã‚’ container ã®ä¸­ã§å‹•ã‹ã™ã€å¿…è¦ãŒã‚ã£ãŸã€‚

ä¸Šè¨˜ã®ãƒˆãƒ¼ã‚¯ã®ä¸­ã§å‡ºã¦ãã‚‹ä»¥ä¸‹ã®ã‚¹ãƒ©ã‚¤ãƒ‰ãŒã€kind ã®ä»•çµ„ã¿ã‚’ç«¯çš„ã«ç¤ºã—ã¦ã„ã¦åˆ†ã‹ã‚Šã‚„ã™ã„ã¨æ€ã„ã¾ã™ã€‚"Node" Container ã®ä¸­ã§ã€kubelet ã‚„ containerd, ãã—ã¦ containered ã‚’é€šã˜ã¦èµ·å‹•ã•ã‚ŒãŸã€ŒKuberentes ã®å‹•ä½œã‚’æ”¯ãˆã‚‹å„ç¨® containerã€ãŒå‹•ã„ã¦ã„ã‚‹äº‹ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

![A slide in the above talk](/images/20201230-kind/slide.webp)

ã“ã“ã¾ã§ã§ã€ã€Œkind ã®å†…éƒ¨æ§‹é€ ã€ã‚’èª¬æ˜ã—ã¾ã—ãŸã€‚æ¬¡ã«ã€å®Ÿéš›ã« kind ã‚’å‹•ã‹ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

## [kind](https://github.com/kubernetes-sigs/kind) ã‚’å‹•ã‹ã—ã¦ã¿ã‚‹

kind ã®åˆ©ç”¨æ–¹æ³•ã¯å®Ÿã¯ã¨ã¦ã‚‚ç°¡å˜ã§ã€README ã§ä»¥ä¸‹ã®ã‚ˆã†ã«è¨€åŠã•ã‚Œã¦ã„ã‚‹é€šã‚Šã€Œ`GO111MODULE="on" go get sigs.k8s.io/kind@v0.9.0 && kind create cluster` ã‚’å®Ÿè¡Œã™ã‚‹ã ã‘ã€ã¨ãªã£ã¦ã„ã¾ã™ã€‚

> If you haveÂ goÂ (1.11+) andÂ dockerÂ installedÂ `GO111MODULE="on" go get sigs.k8s.io/kind@v0.9.0 && kind create cluster`Â is all you need!

cf. https://github.com/kubernetes-sigs/kind#please-see-our-documentation-for-more-in-depth-installation-etc

å®Ÿéš›ã«å®Ÿè¡Œã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã« Kubernetes cluster ä½œæˆãŒé€²ã¿ã¾ã™ã€‚è‡ªåˆ†ã®ç’°å¢ƒã§ã¯ã€Kuberentes cluster ä½œæˆã«ã‹ã‹ã‚‹æ™‚é–“ã¯ 1min å¼·ã§ã—ãŸã€‚

ï¼ˆãªãŠã€`Ensuring node image` ã¨ã„ã† step ã§å°‘ã—æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ãŒã€ã“ã‚Œã¯å¾Œè¿°ã™ã‚‹ã€Œkind ãŒåˆ©ç”¨ã™ã‚‹ `kindest/node` ã¨ã„ã† docker image ã® pull ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã‚‹ã€ã ã‘ã§ã™ã€‚ä¸€åº¦ image pull ãŒå®Œäº†ã™ã‚‹ã¨æ¬¡ã‹ã‚‰ã¯ 30s ç¨‹åº¦ã§é«˜é€Ÿã« Kubernetes cluster ãŒä½œæˆå‡ºæ¥ã‚‹æ§˜ã«ãªã‚Šã¾ã™ï¼‰ã€‚

```console
$ GO111MODULE="on" go get sigs.k8s.io/kind@v0.9.0 && kind create cluster
go: downloading sigs.k8s.io/kind v0.9.0
go: downloading github.com/spf13/cobra v1.0.0
go: downloading k8s.io/apimachinery v0.18.8
go: downloading gopkg.in/yaml.v3 v3.0.0-20200615113413-eeeca48fe776
go: downloading github.com/mattn/go-isatty v0.0.12
go: downloading github.com/alessio/shellescape v1.2.2
go: downloading sigs.k8s.io/yaml v1.2.0
go: downloading github.com/pelletier/go-toml v1.8.0
go: downloading github.com/evanphx/json-patch v0.0.0-20200808040245-162e5629780b
go: downloading golang.org/x/sys v0.0.0-20200814200057-3d37ad5750ed
go: downloading github.com/evanphx/json-patch/v5 v5.1.0
GO111MODULE="on" go get sigs.k8s.io/kind@v0.9.0  8.93s user 3.64s system 102% cpu 12.228 total

Creating cluster "kind" ...
 âœ“ Ensuring node image (kindest/node:v1.19.1) ğŸ–¼
 âœ“ Preparing nodes ğŸ“¦
 âœ“ Writing configuration ğŸ“œ
 âœ“ Starting control-plane ğŸ•¹ï¸
 âœ“ Installing CNI ğŸ”Œ
 âœ“ Installing StorageClass ğŸ’¾
Set kubectl context to "kind-kind"
You can now use your cluster with:

kubectl cluster-info --context kind-kind

Not sure what to do next? ğŸ˜…  Check out https://kind.sigs.k8s.io/docs/user/quick-start/
kind create cluster  4.95s user 2.65s system 9% cpu 1:16.71 total
```

ã“ã‚Œã§æ—¢ã«ã€ŒKubernetes cluster ãŒ  Docker container ã®ä¸­ã§å‹•ã„ã¦ã„ã‚‹çŠ¶æ…‹ã€ã¨ãªã£ã¦ã„ã¾ã™ã€‚ç°¡å˜ã§ã™ã­ï¼

## [kind](https://github.com/kubernetes-sigs/kind) ã§å‹•ã Kubernetes cluster ã‚’åˆ©ç”¨ã—ã¦ã¿ã‚‹

æ¬¡ã«ã€å®Ÿéš›ã« kind ã§å‹•ã Kuberentes cluster ã‚’åˆ©ç”¨ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

`$ kind create cluster` ã‚’å®Ÿè¡Œã—ãŸéš›ã® message ã« `Set kubectl context to "kind-kind"` ã¨å‡ºã¦ã„ãŸã‚ˆã†ã«ã€æ—¢ã« kubectl ã® context ã¯ã€Œkind ã§ä½œæˆã—ãŸ Kubenetes clusterï¼ˆ= `kind-kind` ã¨ã„ã†åå‰ã® clusterï¼‰ã€ã«åˆ‡ã‚Šæ›¿ã‚ã£ã¦ã„ã¾ã™ã€‚ã¤ã¾ã‚Šã€ã“ã®çŠ¶æ…‹ã§ `$ kubectl` ã‚’åˆ©ç”¨ã™ã‚Œã°ã€`kind-kind` cluster ã® API server ã«å¯¾ã—ã¦é€šä¿¡ãŒè¡Œã‚ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

å®Ÿéš›ã€ä»¥ä¸‹ã®ã‚ˆã†ã« `$ kubectl config current-context` ã‚„ `$ kubectl cluster-info` ã®çµæœã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€Œlocal ã§å‹•ã `kind-kind` cluster ã« context ãŒåˆ‡ã‚Šæ›¿ã‚ã£ã¦ã„ã‚‹ã€äº‹ãŒç¢ºèªå‡ºæ¥ã¾ã™ã€‚

```console
$ kubectl config current-context
kind-kind

$ kubectl cluster-info
Kubernetes control plane is running at https://127.0.0.1:55999
KubeDNS is running at https://127.0.0.1:55999/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
```

`$ kubectl` ã§ cluster å†…ã® k8s object ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ä¾‹ãˆã° namespace ã‚„ pod, service ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå†…å®¹ã«ãªã£ã¦ã„ã¾ã™ã€‚

```console
$ kubectl get namespaces
NAME                 STATUS   AGE
default              Active   11m
kube-node-lease      Active   11m
kube-public          Active   11m
kube-system          Active   11m
local-path-storage   Active   11m

$ kubectl get po --all-namespaces
NAMESPACE            NAME                                         READY   STATUS    RESTARTS   AGE
kube-system          coredns-f9fd979d6-9cgbl                      1/1     Running   0          11m
kube-system          coredns-f9fd979d6-wlnmw                      1/1     Running   0          11m
kube-system          etcd-kind-control-plane                      1/1     Running   0          11m
kube-system          kindnet-phgz9                                1/1     Running   0          11m
kube-system          kube-apiserver-kind-control-plane            1/1     Running   0          11m
kube-system          kube-controller-manager-kind-control-plane   1/1     Running   0          11m
kube-system          kube-proxy-dxx9q                             1/1     Running   0          11m
kube-system          kube-scheduler-kind-control-plane            1/1     Running   0          11m
local-path-storage   local-path-provisioner-78776bfc44-66wln      1/1     Running   0          11m

$ kubectl get svc --all-namespaces
NAMESPACE     NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE
default       kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP                  18m
kube-system   kube-dns     ClusterIP   10.96.0.10   <none>        53/UDP,53/TCP,9153/TCP   18m
```

ã•ã‚‰ã«ã€é©å½“ã« deployment ã¨ service ã®è¿½åŠ ã‚‚ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚è‡ªåˆ†ãŒæ˜”ä½œã£ãŸ https://github.com/south37/dumper ã¨ã„ã†ã€Œrequest header ã‚’ print ã™ã‚‹ã ã‘ã® Docker containerã€ã‚’å‹•ã‹ã—ã¦ã¿ã¾ã™ã€‚

ã¾ãšã€deployment ã¨ service ã® manifest file ã‚’ç”¨æ„ã—ã¾ã™ã€‚

```yaml
# dumper-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: dumper
  name: dumper
  namespace: default
spec:
  selector:
    matchLabels:
      app: dumper
  template:
    metadata:
      annotations:
      labels:
        app: dumper
      name: dumper
    spec:
      containers:
      - image: south37/dumper
        livenessProbe:
          httpGet:
            path: /ping
            port: 8080
        name: dumper
        ports:
        - containerPort: 8080
          name: http
        readinessProbe:
          httpGet:
            path: /ping
            port: 8080
```

```yaml
# dumper-service.yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    app: dumper
  name: dumper
  namespace: default
spec:
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: 8080
  selector:
    app: dumper
  type: ClusterIP
```

æ¬¡ã«ã€ã“ã‚Œã‚‰ã® manfest file ã‚’ apply ã—ã¾ã™ã€‚

```console
$ kubectl apply -f dumper-deployment.yaml
deployment.apps/dumper created

$ kubectl apply -f dumper-service.yaml
service/dumper created
```

apply ã—ãŸã‚‚ã®ãŒã¡ã‚ƒã‚“ã¨ä½œã‚‰ã‚Œã¦ã„ã‚‹äº‹ã‚’ç¢ºèªã—ã¾ã™ã€‚

```console
$ kubectl get all -n default
NAME                          READY   STATUS    RESTARTS   AGE
pod/dumper-6465654fdc-qn729   1/1     Running   0          118s

NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
service/dumper       ClusterIP   10.110.60.42   <none>        80/TCP    114s
service/kubernetes   ClusterIP   10.96.0.1      <none>        443/TCP   21m

NAME                     READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/dumper   1/1     1            1           118s

NAME                                DESIRED   CURRENT   READY   AGE
replicaset.apps/dumper-6465654fdc   1         1         1       118s
```

ã¾ãšã€pod ã® log ã‚’è¦‹ã¦ã¿ã¾ã™ã€‚ã™ã‚‹ã¨ã€healthcheck ç”¨ã® `GET /ping` ã® reqeust ãŒæ¥ã¦ã„ã‚‹äº‹ãŒç¢ºèªã§ãã¾ã™ã€‚

```console
$ kubectl logs dumper-6465654fdc-qn729
.
.
.
2020/12/30 12:09:55 GET /ping HTTP/1.1
2020/12/30 12:09:55 Host: 10.244.0.5:8080
2020/12/30 12:09:55 User-Agent: kube-probe/1.19
2020/12/30 12:09:55 Accept-Encoding: gzip
2020/12/30 12:09:55 Connection: close
```

æ¬¡ã«ã€Kuberentes cluster ã®ä¸­ã‹ã‚‰ Service ã‚’é€šã—ãŸ request ã‚’ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ curl ãŒå…¥ã£ã¦ã„ã‚‹ docker image ã¨ã—ã¦ `radial/busyboxplus:curl` ã‚’ä½¿ã†ã“ã¨ã«ã—ã¾ã™ï¼ˆæ³¨: `radial/busyboxplus:curl` ã¯ https://kubernetes.io/docs/concepts/services-networking/connect-applications-service/ ã®ä¸­ã§ã‚‚åˆ©ç”¨ã•ã‚Œã¦ã‚‹ã®ã§ã€å®‰å…¨ãª image ã ã¨åˆ¤æ–­ã—ã¦åˆ©ç”¨ã—ã¦ã¾ã™ï¼‰ã€‚

ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã« Kubernetes cluster å†…ã® pod ã‹ã‚‰ `$ curl http://dumper.default` ã§ ã€Œ`default` namespace ã® `dumper` service ã¸ HTTP requestã€ã‚’ã—ã¦ã€ã¡ã‚ƒã‚“ã¨ response ãŒè¿”ã‚‹äº‹ã‚’ç¢ºèªå‡ºæ¥ã¾ã—ãŸï¼

```console
$ kubectl run --rm -it busybox --image=radial/busyboxplus:curl
If you don't see a command prompt, try pressing enter.
[ root@busybox:/ ]$ curl http://dumper.default
Hello, dumper!
```

pod ã® log ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€ã¡ã‚ƒã‚“ã¨ä¸Šè¨˜ request ãŒ pod ã«åˆ°é”ã—ã¦ã„ã‚‹ã“ã¨ã‚‚ç¢ºèªã§ãã¾ã™ã€‚

```console
$ kubectl logs dumper-6465654fdc-qn729
.
.
.
2020/12/30 12:12:00 GET / HTTP/1.1
2020/12/30 12:12:00 Host: dumper.default
2020/12/30 12:12:00 User-Agent: curl/7.35.0
2020/12/30 12:12:00 Accept: */*
```

ç°¡å˜ã«ã§ã¯ã‚ã‚Šã¾ã™ãŒã€Kubernetes cluster ã¨ã—ã¦ã®å‹•ä½œãŒç¢ºèªã§ãã¾ã—ãŸã€‚

## Docker container ã¨ã—ã¦å‹•ã Node container ã®ä¸­ã‚’è¦‹ã¦ã¿ã‚‹


æ¬¡ã«ã€kind ã®å‹•ä½œã‚’ã‚‚ã†å°‘ã—æ·±æ˜ã‚Šã—ã¦ã¿ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€[Deep Dive: Kind -  KubeCon + CloudNativeCon North America 2019](https://www.youtube.com/watch?v=tT-GiZAr6eQ) ã®ä¸­ã§ç´¹ä»‹ã•ã‚Œã¦ã„ãŸã€ŒNode container ã®å‹•ä½œã€ã‚’ã‚‚ã†å°‘ã—è¦‹ã¦ã¿ã¾ã™ã€‚

ã¾ãšã€Kubernetes cluster ã‚’ä¸€åº¦å‰Šé™¤ã—ã¦ä½œã‚Šç›´ã™ã“ã¨ã«ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€ã€Œä½œæˆã•ã‚ŒãŸã°ã‹ã‚Šã®çŠ¶æ…‹ã® Kubernetes clusterã€ã§å®Ÿé¨“ã™ã‚‹ãŸã‚ã®æ“ä½œã§ã™ï¼ˆç‰¹ã«æ°—ã«ãªã‚‰ãªã„äººã¯ä¸è¦ã§ã™ï¼‰ã€‚

```console
$ kind delete cluster
Deleting cluster "kind" ...

$ kind create cluster
Creating cluster "kind" ...
 âœ“ Ensuring node image (kindest/node:v1.19.1) ğŸ–¼
 âœ“ Preparing nodes ğŸ“¦
 âœ“ Writing configuration ğŸ“œ
 âœ“ Starting control-plane ğŸ•¹ï¸
 âœ“ Installing CNI ğŸ”Œ
 âœ“ Installing StorageClass ğŸ’¾
Set kubectl context to "kind-kind"
You can now use your cluster with:

kubectl cluster-info --context kind-kind

Not sure what to do next? ğŸ˜…  Check out https://kind.sigs.k8s.io/docs/user/quick-start/
kind create cluster  4.62s user 2.53s system 19% cpu 36.518 total
```

æ¬¡ã«ã€`$ kind create cluster` ã‚’å®Ÿè¡Œã—ãŸå¾Œã®çŠ¶æ…‹ã§ `$ docker ps` ã™ã‚‹ã¨ã€`kindest/node:v1.19.1` ã¨ã„ã† image ã® container ãŒèµ·å‹•ã—ã¦ã„ã‚‹äº‹ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚ã“ã‚ŒãŒã€kind ãŒåˆ©ç”¨ã™ã‚‹ã€ŒNode containerã€ã®ã‚ˆã†ã§ã™ã€‚

```console
$ docker ps
CONTAINER ID   IMAGE                  COMMAND                  CREATED              STATUS          PORTS                       NAMES
45a383679dd2   kindest/node:v1.19.1   "/usr/local/bin/entrâ€¦"   About a minute ago   Up 59 seconds   127.0.0.1:56856->6443/tcp   kind-control-plane
```

`$ docker exec` ã—ã¦ Node container ã®ä¸­ã‚’ã¿ã¦ã¿ã¾ã—ã‚‡ã†ã€‚`$ ps fax` ã§ process ä¸€è¦§ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€[Deep Dive: Kind -  KubeCon + CloudNativeCon North America 2019](https://www.youtube.com/watch?v=tT-GiZAr6eQ ) ã®ä¸­ã§èª¬æ˜ã•ã‚Œã¦ã„ãŸé€šã‚Šã€Kubernetes ã®å‹•ä½œã‚’æ”¯ãˆã‚‹æ§˜ã€…ãª process ãŒèµ·å‹•ã—ã¦ã„ã‚‹äº‹ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚`containerd` ã‚„ `kubelet` ãªã©ä¸€éƒ¨ã‚’é™¤ãã¨ã€ãã®ã»ã‹ã® process ã¯ `/usr/local/bin/containerd-shim-runc-v2` çµŒç”±ã§èµ·å‹•ã—ã¦ã„ã‚‹ï¼ˆ= container ã¨ã—ã¦èµ·å‹•ã—ã¦ã„ã‚‹ï¼‰ã“ã¨ã‚‚åˆ†ã‹ã‚Šã¾ã™ã€‚

```
$ docker exec -it 45a383679dd2 bash
root@kind-control-plane:/# ps fax
    PID TTY      STAT   TIME COMMAND
   2060 pts/1    Ss     0:00 bash
   2189 pts/1    R+     0:00  \_ ps fax
      1 ?        Ss     0:00 /sbin/init
    124 ?        S<s    0:00 /lib/systemd/systemd-journald
    135 ?        Ssl    0:11 /usr/local/bin/containerd
    310 ?        Sl     0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 1c426469eb3ae09b744f1c116e6798c65886e218271dfa105fba747b4bfde0d3 -address /run/containerd/containerd.soc
    405 ?        Ss     0:00  \_ /pause
    502 ?        Ssl    0:06  \_ kube-scheduler --authentication-kubeconfig=/etc/kubernetes/scheduler.conf --authorization-kubeconfig=/etc/kubernetes/scheduler.conf --bind-address=127.0.0.1 --ku
    311 ?        Sl     0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 23d54713b4401fb309725273c78961ea5d7f3a5be157d2a139813b9b9611e220 -address /run/containerd/containerd.soc
    418 ?        Ss     0:00  \_ /pause
    620 ?        Ssl    0:20  \_ etcd --advertise-client-urls=https://172.19.0.2:2379 --cert-file=/etc/kubernetes/pki/etcd/server.crt --client-cert-auth=true --data-dir=/var/lib/etcd --initial-a
    318 ?        Sl     0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id a24a84c14111721de85b657f2bb0b89db44d87e97452ef86690060a0f0fcd3bc -address /run/containerd/containerd.soc
    425 ?        Ss     0:00  \_ /pause
    563 ?        Ssl    1:08  \_ kube-apiserver --advertise-address=172.19.0.2 --allow-privileged=true --authorization-mode=Node,RBAC --client-ca-file=/etc/kubernetes/pki/ca.crt --enable-admissi
    373 ?        Sl     0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 8a6a56e83a590f4958dbd3262e4b0adbe36acad229ebcb54ef13c657f39c2c0a -address /run/containerd/containerd.soc
    433 ?        Ss     0:00  \_ /pause
    548 ?        Ssl    0:24  \_ kube-controller-manager --allocate-node-cidrs=true --authentication-kubeconfig=/etc/kubernetes/controller-manager.conf --authorization-kubeconfig=/etc/kubernetes
    667 ?        Ssl    0:25 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/kubelet/config.yaml --cont
    797 ?        Sl     0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 841020b0c947c1a8c2047a542268bf3dd91f8fb6b15cfc0a993dc61c0769e660 -address /run/containerd/containerd.soc
    819 ?        Ss     0:00  \_ /pause
    898 ?        Ssl    0:00  \_ /usr/local/bin/kube-proxy --config=/var/lib/kube-proxy/config.conf --hostname-override=kind-control-plane
    833 ?        Sl     0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 6171f628b9c0658a1983b198160fe76b53eeb4118aa8a0c71491ff5516453268 -address /run/containerd/containerd.soc
    864 ?        Ss     0:00  \_ /pause
    948 ?        Ssl    0:00  \_ /bin/kindnetd
   1110 ?        Sl     0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 1fd32fb832a5e3782d1f39b26b99a30de8872a0a69600a77db3631f274eeb819 -address /run/containerd/containerd.soc
   1153 ?        Ss     0:00  \_ /pause
   1226 ?        Ssl    0:03  \_ /coredns -conf /etc/coredns/Corefile
   1112 ?        Sl     0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 725b634f7fc5d93ebfb1e63afb8aabcd936e6297ed7ab552e314e1cc90efeec5 -address /run/containerd/containerd.soc
   1160 ?        Ss     0:00  \_ /pause
   1229 ?        Ssl    0:01  \_ local-path-provisioner --debug start --helper-image k8s.gcr.io/build-image/debian-base:v2.1.0 --config /etc/config/config.json
   1350 ?        Sl     0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 9d07db434b356d9fddb2ae31715adc1209406a604b7068560f379832f5d79ba2 -address /run/containerd/containerd.soc
   1373 ?        Ss     0:00  \_ /pause
   1404 ?        Ssl    0:03  \_ /coredns -conf /etc/coredns/Corefile
```

containerd ã§èµ·å‹•ã—ã¦ã„ã‚‹ container ã¯ã€containerd ã® CLI tool ã§ã‚ã‚‹ `ctr` ã§ç®¡ç†ã™ã‚‹äº‹ãŒå‡ºæ¥ã‚‹ã¯ãšã§ã™ã€‚å°‘ã—è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ã¾ãšã€namespace ä¸€è¦§ã‚’è¦‹ã¦ã¿ã‚‹ã¨ `k8s.io` ã¨ã„ã†åå‰ã® namespace ãŒè¦‹ã¤ã‹ã‚Šã¾ã™ï¼ˆæ³¨: ã“ã® namespace ã¯ kuberentes ã® namespace ã¨ã¯ç„¡é–¢ä¿‚ã§ã€ã€Œcontainerd ãŒ container ã‚’ç®¡ç†ã™ã‚‹éš›ã«åˆ©ç”¨ã™ã‚‹ namespace æ©Ÿèƒ½ã€ã®ã¯ãšã§ã™ï¼‰ã€‚

```
root@kind-control-plane:/# ctr namespaces ls
NAME   LABELS
k8s.io
```

æ¬¡ã«ã€ã“ã® `k8s.io` namespace å†…ã® container ä¸€è¦§ã‚’ `$ ctr --namespace k8s.io containers ls` ã§è¦‹ã¦ã¿ã‚‹ã¨ã€äºˆæƒ³é€šã‚Šã€ŒKuberentes cluster ã®å‹•ä½œã«åˆ©ç”¨ã•ã‚Œã‚‹ container ä¸€è¦§ã€ã‚’ã¿ã‚‹äº‹ãŒå‡ºæ¥ã¾ã—ãŸã€‚

```
root@kind-control-plane:/# ctr --namespace k8s.io containers ls
CONTAINER                                                           IMAGE                                                                      RUNTIME
0e7fc11f71638b86f8fd41f046101ebcb16b48976f06826add2d35df4e2ccc10    k8s.gcr.io/kube-controller-manager:v1.19.1                                 io.containerd.runc.v2
114d8f7f34ebc00c00236d7a111961193a6fa300dc90a4114385134f9eeda412    k8s.gcr.io/kube-proxy:v1.19.1                                              io.containerd.runc.v2
1c426469eb3ae09b744f1c116e6798c65886e218271dfa105fba747b4bfde0d3    k8s.gcr.io/pause:3.3                                                       io.containerd.runc.v2
1fd32fb832a5e3782d1f39b26b99a30de8872a0a69600a77db3631f274eeb819    k8s.gcr.io/pause:3.3                                                       io.containerd.runc.v2
2299e2a7b2b7afbb0789b30a4d7f4e57220a650f7368c04439e91c72e5049356    k8s.gcr.io/kube-apiserver:v1.19.1                                          io.containerd.runc.v2
23d54713b4401fb309725273c78961ea5d7f3a5be157d2a139813b9b9611e220    k8s.gcr.io/pause:3.3                                                       io.containerd.runc.v2
35ab22ae753e043553188810bddfec43aa048d8c93f1ca38cf868ee31dbe06fc    k8s.gcr.io/coredns:1.7.0                                                   io.containerd.runc.v2
6171f628b9c0658a1983b198160fe76b53eeb4118aa8a0c71491ff5516453268    k8s.gcr.io/pause:3.3                                                       io.containerd.runc.v2
6212a3ea51397a8491a8defb188faa1c9afb4b678a8fa102ab15ba8c78f98aa2    sha256:0369cf4303ffdb467dc219990960a9baa8512a54b0ad9283eaf55bd6c0adb934    io.containerd.runc.v2
624a9cf197014dcdbf0be5ddd68995566d14ceab00c8ca18fd51eb35cfe999cb    k8s.gcr.io/kube-scheduler:v1.19.1                                          io.containerd.runc.v2
62d494fe1a94a396494ecd30cfa8538db2e1d2055fedac216d19fd21332d3841    sha256:b77790820d01598b2c56f823fa489e3f56be2cb5d6f7dd9eecd68a1995b89c13    io.containerd.runc.v2
725b634f7fc5d93ebfb1e63afb8aabcd936e6297ed7ab552e314e1cc90efeec5    k8s.gcr.io/pause:3.3                                                       io.containerd.runc.v2
841020b0c947c1a8c2047a542268bf3dd91f8fb6b15cfc0a993dc61c0769e660    k8s.gcr.io/pause:3.3                                                       io.containerd.runc.v2
8a6a56e83a590f4958dbd3262e4b0adbe36acad229ebcb54ef13c657f39c2c0a    k8s.gcr.io/pause:3.3                                                       io.containerd.runc.v2
9d07db434b356d9fddb2ae31715adc1209406a604b7068560f379832f5d79ba2    k8s.gcr.io/pause:3.3                                                       io.containerd.runc.v2
a24a84c14111721de85b657f2bb0b89db44d87e97452ef86690060a0f0fcd3bc    k8s.gcr.io/pause:3.3                                                       io.containerd.runc.v2
b7775d2582ea9fdd481cf308d9c8bafa28fffbdaa2c8c0bad3377a9254876a59    k8s.gcr.io/coredns:1.7.0                                                   io.containerd.runc.v2
ecbad3d6f6f5321e46b0d3ac395cb25227b42cfc04b1cec5a2b659fe45fab6cc    sha256:e422121c9c5f97623245b7e600eeb5e223ee623f21fa04da985ae71057d8d70b    io.containerd.runc.v2
```

ã“ã®ã‚ˆã†ã«ã€ã€ŒNode container ã®ä¸­ã§ containerd ã‚’å‹•ã‹ã—ã€ãã® containerd çµŒç”±ã§ Kuberentes cluster ã«å¿…è¦ãª container ã‚’å‹•ã‹ã™ã€ã¨ã„ã†å½¢ã§ kind ã¯å‹•ä½œã™ã‚‹ã‚ˆã†ã§ã™ã€‚[Deep Dive: Kind -  KubeCon + CloudNativeCon North America 2019](https://www.youtube.com/watch?v=tT-GiZAr6eQ) ã®ä¸­ã§èª¬æ˜ã•ã‚Œã¦ã„ãŸäº‹ã§ã¯ã‚ã‚Šã¾ã™ãŒã€æ”¹ã‚ã¦ãã®å‹•ä½œã‚’ç¢ºèªã§ãã¾ã—ãŸã€‚

## [kind](https://github.com/kubernetes-sigs/kind) ã¨ [minikube](https://github.com/kubernetes/minikube) ã®ä½¿ã„åˆ†ã‘ã«ã¤ã„ã¦


ã•ã¦ã€ã“ã“ã¾ã§ã¯ [kind](https://github.com/kubernetes-sigs/kind) ã¨ã„ã†ãƒ„ãƒ¼ãƒ«ã®æ©Ÿèƒ½ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ãã¾ã—ãŸã€‚ä¸€æ–¹ã§ã€ã€Œlocal ã§ Kubernetes ã‚’å‹•ã‹ã™ãƒ„ãƒ¼ãƒ«ã€ã¨ã—ã¦ã¯ä»–ã« [minikube](https://github.com/kubernetes/minikube) ã‚‚å­˜åœ¨ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ä½¿ã„åˆ†ã‘ã¯ã©ã†ã™ã‚‹ã®ãŒè‰¯ã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ

`kind vs minikube` ã§æ¤œç´¢ã™ã‚‹ã¨ã€ã“ã®2ã¤ã®ä½¿ã„åˆ†ã‘ã«ã¤ã„ã¦è¨€åŠã—ã¦ã„ã‚‹è¨˜äº‹ãŒã„ãã¤ã‹è¦‹ã¤ã‹ã‚Šã¾ã™ã€‚ä¾‹ãˆã° https://brennerm.github.io/posts/minikube-vs-kind-vs-k3s.html ã¨ã„ã†è¨˜äº‹ã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãã‚Œãã‚Œã®ç‰¹å¾´ãŒè¿°ã¹ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

- [minikube](https://github.com/kubernetes/minikube)
	1. VM ã§ Kubernetes ã‚’èµ·å‹•ã™ã‚‹
	2. `$ minikube dashboard` æ©Ÿèƒ½ã‚„ [minikube ã® addon system](https://minikube.sigs.k8s.io/docs/handbook/deploying/) ãŒæœ‰ç”¨
- [kind](https://github.com/kubernetes-sigs/kind)
	1. Docker container ã§ Kubernetes ã‚’èµ·å‹•ã™ã‚‹
	2. `$ kind load docker-image <my-custom-image>:<tag>` ã‚’å®Ÿè¡Œã™ã‚‹äº‹ã§ **local ã§ build ã—ãŸ image ã‚’ container registry ã¸  push ã™ã‚‹äº‹ãªã Kubernetes cluster ã‹ã‚‰åˆ©ç”¨ã™ã‚‹äº‹ãŒå¯èƒ½**

kind ã«ã¤ã„ã¦è¨€ãˆã°ã€`$ kind load docker-image` ã®æ©Ÿèƒ½ã¯ã‹ãªã‚Šå¼·åŠ›ã§ã€ä¾‹ãˆã° custom controller ã®ã‚ˆã†ãªã€ŒKubernetes ã®ä¸­ã§å‹•ã‹ã—ãªãŒã‚‰é–‹ç™ºã‚’é€²ã‚ãŸã„ã‚‚ã®ã€ã«ãŠã„ã¦ã¯æ¥µã‚ã¦æœ‰ç”¨ã§ã™ã€‚å®Ÿéš›ã€ã“ã†ã„ã£ãŸå´é¢ãŒã‚ã‚‹ãŸã‚ã‹ã€[kubebuilder ã® Tutorial ã® Quick Start](https://book.kubebuilder.io/quick-start.html#test-it-out) ã§ã¯ã€Œlocal ã§ Kuberentes cluster ã‚’å‹•ã‹ã™é¸æŠè‚¢ã€ã¨ã—ã¦ kind ãŒç´¹ä»‹ã•ã‚Œã¦ã„ãŸã‚Šã—ã¾ã™ã€‚

> Youâ€™ll need a Kubernetes cluster to run against. You can useÂ KINDÂ to get a local cluster for testing, or run against a remote cluster.

cf. https://book.kubebuilder.io/quick-start.html#test-it-out

ã¾ãŸã€ã€ŒVM ã‚ˆã‚Šã‚‚ Docker container ã®æ–¹ãŒæ‰±ã„ã«æ…£ã‚Œã¦ã‚‹ã€ãªã©ã®ã‚±ãƒ¼ã‚¹ã§ã‚‚ kind ã®åˆ©ç”¨ã«ã¯ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šãã†ã ã¨å€‹äººçš„ã«ã¯æ„Ÿã˜ã¾ã—ãŸã€‚

## ã¾ã¨ã‚

[kind](https://github.com/kubernetes-sigs/kind) ã®å†…éƒ¨æ§‹é€ ã‚„ä½¿ã„æ–¹ã«ã¤ã„ã¦ã–ã£ã¨çœºã‚ã¦ã¿ã¾ã—ãŸã€‚

ã€ŒKuberentes ã‚’ Docker container ã®ä¸­ã§å‹•ã‹ã™ã€ã¨ã„ã†è¨€è‘‰ã ã‘ã‚’èãã¨çªæ‹å­ã‚‚ç„¡ã„ã‚¢ã‚¤ãƒ‡ã‚£ã‚¢ã«èã“ãˆã¾ã™ãŒã€`kubelet` ã‚„ `containerd`, ãã®ä»–ã® Kubernetes cluster ã«å¿…è¦ãª component ã‚’ "Node" image ã®ä¸­ã«ã¾ã¨ã‚ã¦é…å¸ƒã—ã¦ã‚‹ã¨æ€ãˆã°ç¢ºã‹ã«è‡ªç„¶ã§ã™ã—ã€å®Ÿéš›ã«ã¡ã‚ƒã‚“ã¨å‹•ä½œã™ã‚‹ã“ã¨ã‚‚ç¢ºèªã§ãã¾ã—ãŸã€‚

Kuberentes ã® CI ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹é™ã‚Šã€ã“ã‚Œã‹ã‚‰ã‚‚ç¶™ç¶šã—ã¦ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã•ã‚Œã¦ã„ããã†ãªã®ã‚‚è‰¯ã„ç‚¹ã§ã™ã€‚ã€Œ30s ã§ Kubernetes cluster ã‚’èµ·å‹•ã—ã¦æ°—è»½ã«å‹•ã‹ã›ã‚‹ãƒ„ãƒ¼ãƒ«ã€ã¨ã—ã¦ã€ã¨ã¦ã‚‚æœ‰ç”¨ãªã‚‚ã®ã ã¨è¨€ãˆãã†ã§ã™ã€‚

ãªãŠã€ä»Šå›ã¯ã€Œkind ã® Node container ã§å‹•ã container ä¸€è¦§ã‚’çœºã‚ãŸã€ã ã‘ã§ã€1ã¤1ã¤ã® container ã®å‹•ãã«ã¤ã„ã¦ã¯ç‰¹ã«è¨€åŠã—ã¾ã›ã‚“ã§ã—ãŸã€‚ãã®ã»ã¨ã‚“ã©ã¯ã€ŒKubernetes cluster ã«å…±é€šã§å¿…è¦ãª componentã€ã®ã¯ãšã§ã™ãŒã€`kindnetd` ã¯ kind ã«ãŠã‘ã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® CNI plugin ã§ã‚ã‚‹ [kindnet](https://github.com/aojea/kindnet) ã® daemon ã ãã†ã§ã™ã€‚

[Deep Dive: Kind - KubeCon + CloudNativeCon North America 2019](https://www.youtube.com/watch?v=tT-GiZAr6eQ) ã§ã¯ã“ã® [kindnet](https://github.com/aojea/kindnet) ã‚’å«ã‚ã¦ã€ã“ã®ãƒ–ãƒ­ã‚°ã§è¨€åŠã—ã¦ãªã„æ§˜ã€…ãªäº‹ã‚’èª¬æ˜ã—ã¦ã‚‹ã®ã§ã€ã•ã‚‰ã«è©³ç´°ãŒæ°—ã«ãªã‚‹æ–¹ã¯ãœã²å‹•ç”»ã®æ–¹ã‚‚ã¿ã¦ã¿ã¦ãã ã•ã„ã€‚ã¾ãŸã€è‡ªåˆ†ã‚‚ä¸€éƒ¨ã—ã‹èª­ã‚“ã§ã¾ã›ã‚“ãŒã€kind ã® document (https://kind.sigs.k8s.io/) ã‚‚ç†è§£ã‚’æ·±ã‚ã‚‹ä¸Šã§ã¨ã¦ã‚‚æœ‰ç”¨ã ã¨æ€ã„ã¾ã™ã€‚


## å‚è€ƒæƒ…å ±

- Kubernetes tools: https://kubernetes.io/docs/tasks/tools/
- kind: https://github.com/kubernetes-sigs/kind
- kind quick start: https://kind.sigs.k8s.io/docs/user/quick-start
- Deep Dive: Kind - KubeCon + CloudNativeCon North America 2019: https://www.youtube.com/watch?v=tT-GiZAr6eQ


## ãŠã¾ã‘: æ—¢ã« node image ã‚’ pull æ¸ˆã®å ´åˆã« Kuberentes cluster ä½œæˆã«ã‹ã‹ã‚‹æ™‚é–“ã«ã¤ã„ã¦


æœ€åˆã« kind ã‚’å‹•ã‹ã—ã¦ã¿ãŸéš›ã«ã€ã€Œ`kindest/node` ã® docker pull éƒ¨åˆ†ã§æ™‚é–“ãŒã‹ã‹ã‚‹ã€ã¨æ›¸ãã¾ã—ãŸã€‚ãã“ã§ã€ã€Œæ—¢ã« node image ã‚’ pull æ¸ˆã¿ã®å ´åˆã€ã«ã¤ã„ã¦ã‚‚ã€è©¦ã—ã«è¨ˆæ¸¬ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ã¾ãšã€å…ˆã»ã©ä½œæˆã—ãŸ cluster ã‚’å‰Šé™¤ã—ã¾ã™ã€‚

```console
$ kind delete cluster
Deleting cluster "kind" ...
```

ã“ã®çŠ¶æ…‹ã§ã‚‚ã€`kindest/node` docker image ã¯æ®‹ã£ã¦ã„ã‚‹äº‹ãŒç¢ºèªã§ãã¾ã™ã€‚

```console
$ docker images | grep kindest
kindest/node                      <none>               37ddbc9063d2   3 months ago    1.33GB
```

æ¬¡ã«ã€ã“ã®çŠ¶æ…‹ã§å†åº¦ `$ kind create cluster` ã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚

```console
$ kind create cluster
Creating cluster "kind" ...
 âœ“ Ensuring node image (kindest/node:v1.19.1) ğŸ–¼
 âœ“ Preparing nodes ğŸ“¦
 âœ“ Writing configuration ğŸ“œ
 âœ“ Starting control-plane ğŸ•¹ï¸
 âœ“ Installing CNI ğŸ”Œ
 âœ“ Installing StorageClass ğŸ’¾
Set kubectl context to "kind-kind"
You can now use your cluster with:

kubectl cluster-info --context kind-kind

Have a nice day! ğŸ‘‹
kind create cluster  4.53s user 2.37s system 21% cpu 32.535 total
```

ä»Šå›ã¯ã€ä¸Šè¨˜ã®ã‚ˆã†ã« 30s ç¨‹åº¦ã§ Kubernetes cluster ãŒèµ·å‹•ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã—ãŸï¼ğŸ‰ Node image ã® pull ãŒç„¡ã‘ã‚Œã°ã€Kuberentes cluster ã‚’ã¨ã¦ã‚‚ç´ æ—©ãä½œæˆå‡ºæ¥ã‚‹äº‹ãŒåˆ†ã‹ã‚Šã¾ã™ã­ï¼

## ãŠã¾ã‘ 2: deployment ã‚’ apply ã—ãŸçŠ¶æ…‹ã§ Node container ã®ä¸­ã‚’è¦‹ã¦ã¿ã‚‹

deployment ã‚’ apply ã—ãŸçŠ¶æ…‹ã§ã€Node container  ã®ä¸­ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```console
$ kubectl apply -f dumper-deployment.yaml
deployment.apps/dumper created
```

ã“ã®çŠ¶æ…‹ã ã¨ã€ï¼ˆå½“ç„¶ã§ã¯ã‚ã‚Šã¾ã™ãŒï¼‰apply ã—ãŸå†…å®¹ã® pod ã«ç›¸å½“ã™ã‚‹ container ãŒèµ·å‹•ã—ã¦ã„ã‚‹æ§˜å­ã‚’ç¢ºèªã§ãã¾ã™ã€‚containerd ã®å‹•ä½œã‚’æ„Ÿã˜ã‚‹äº‹ãŒå‡ºæ¥ã¦ã€ã¨ã¦ã‚‚è‰¯ã„ã§ã™ã­ï¼

```console
$ docker exec -it 7ff1d05ef709 bash

root@kind-control-plane:/# ps fax
    PID TTY      STAT   TIME COMMAND
.
.
.
   1729 ?        Sl     0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 34794c98df201080b5b22bcef08805e03748023c35f0deec77f962ff301a6835 -address /run/containerd/containerd.sock
   1752 ?        Ss     0:00  \_ /pause
   1879 ?        Ssl    0:00  \_ /app/dumper

root@kind-control-plane:/# ctr --namespace k8s.io images ls | grep dumper
docker.io/south37/dumper:latest                                                                  application/vnd.docker.distribution.manifest.v2+json sha256:5efcf15fbd3439b2c2fff2415957933b45b9531401526c026c41219aed15701c 290.0 MiB linux/amd64 io.cri-containerd.image=managed
docker.io/south37/dumper@sha256:5efcf15fbd3439b2c2fff2415957933b45b9531401526c026c41219aed15701c application/vnd.docker.distribution.manifest.v2+json sha256:5efcf15fbd3439b2c2fff2415957933b45b9531401526c026c41219aed15701c 290.0 MiB linux/amd64 io.cri-containerd.image=managed

root@kind-control-plane:/# ctr --namespace k8s.io containers ls | grep dumper
ab80cafc653433c2b74713b85679797b4ffad5ae54eed733bb40d41af7bb9f43    docker.io/south37/dumper:latest                                            io.containerd.runc.v2
```

## ãŠã¾ã‘ 3: `$ kind load docker-image` ã®å®Ÿè£…ã«ã¤ã„ã¦
kind ã®å¼·åŠ›ãªæ©Ÿèƒ½ã§ã‚ã‚‹ `$ kind load docker-image` æ©Ÿèƒ½ãŒã©ã†å®Ÿç¾ã•ã‚Œã¦ã„ã‚‹ã®ã‹æ°—ã«ãªã£ãŸã®ã§ã€å°‘ã—ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚“ã§ã¿ã¾ã—ãŸï¼ˆå¯¾è±¡ã¯ kind ã® `v0.9.0` tag ã®ã‚³ãƒ¼ãƒ‰ã§ã™ï¼‰ã€‚

ã¾ãšã€`$ kind load` ã‚³ãƒãƒ³ãƒ‰è‡ªä½“ã¯ https://github.com/kubernetes-sigs/kind/blob/v0.9.0/pkg/cmd/kind/load/load.go ã§å®Ÿè£…ã•ã‚Œã¦ã„ã¦ã€ãã®ä¸­ã® `$ kind load docker-image` ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰ã¯ https://github.com/kubernetes-sigs/kind/blob/v0.9.0/pkg/cmd/kind/load/docker-image/docker-image.go ã§å®Ÿè£…ã•ã‚Œã¦ã‚‹ã‚ˆã†ã§ã™ã€‚ã•ã‚‰ã«ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿é€²ã‚ã‚‹ã¨ã€`nodeutils` package ã® `LoadImageArchive` ã¨ã„ã†é–¢æ•°ã«ãŸã©ã‚Šç€ãã¾ã™ã€‚

```go
import (
	...
	dockerimage "sigs.k8s.io/kind/pkg/cmd/kind/load/docker-image"
	...
)

// NewCommand returns a new cobra.Command for get
func NewCommand(logger log.Logger, streams cmd.IOStreams) *cobra.Command {
	cmd := &cobra.Command{
		Args:  cobra.NoArgs,
		Use:   "load",
		Short: "Loads images into nodes",
		Long:  "Loads images into node from an archive or image on host",
	}
	// add subcommands
	cmd.AddCommand(dockerimage.NewCommand(logger, streams))
	cmd.AddCommand(imagearchive.NewCommand(logger, streams))
	return cmd
}
```

cf. https://github.com/kubernetes-sigs/kind/blob/v0.9.0/pkg/cmd/kind/load/load.go#L38

```go
	// Load the image on the selected nodes
	fns := []func() error{}
	for _, selectedNode := range selectedNodes {
		selectedNode := selectedNode // capture loop variable
		fns = append(fns, func() error {
			return loadImage(imageTarPath, selectedNode)
		})
	}
```

cf. https://github.com/kubernetes-sigs/kind/blob/v0.9.0/pkg/cmd/kind/load/docker-image/docker-image.go#L149-L156

```go
// loads an image tarball onto a node
func loadImage(imageTarName string, node nodes.Node) error {
	f, err := os.Open(imageTarName)
	if err != nil {
		return errors.Wrap(err, "failed to open image")
	}
	defer f.Close()
	return nodeutils.LoadImageArchive(node, f)
}
```

cf. https://github.com/kubernetes-sigs/kind/blob/v0.9.0/pkg/cmd/kind/load/docker-image/docker-image.go#L162-L170

`nodeutils.LoadImageArchive` ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå®Ÿè£…ã«ãªã£ã¦ã„ã¦ã€ã€ŒNode container ã®ä¸­ã§ `$ ctr` ã‚³ãƒãƒ³ãƒ‰ã‚’å‘¼ã³å‡ºã—ã¦ã€container image ã® load ã‚’è¡Œã†ã€ã‚ˆã†ã§ã™ã€‚

```go
// LoadImageArchive loads image onto the node, where image is a Reader over an image archive
func LoadImageArchive(n nodes.Node, image io.Reader) error {
	cmd := n.Command("ctr", "--namespace=k8s.io", "images", "import", "-").SetStdin(image)
	if err := cmd.Run(); err != nil {
		return errors.Wrap(err, "failed to load image")
	}
	return nil
}
```

cf. https://github.com/kubernetes-sigs/kind/blob/v0.9.0/pkg/cluster/nodeutils/util.go#L77-L84

`nodeutils.LoadImageArchive` ã¯ã€Œ1 ã¤ 1 ã¤ã® Node container ã«å¯¾ã—ã¦ loop ã‚’å›ã—ã¦å®Ÿè¡Œã—ã¦ã‚‹ã€ã‚ˆã†ã§ã™ã€‚ã¤ã¾ã‚Šã€é­”æ³•ã®ã‚ˆã†ã«è¦‹ãˆãŸ `$ kind load docker-image` ã®æ©Ÿèƒ½ã¯ã€ã€Œãã‚Œãã‚Œã® Node container ã®ä¸­ã§ `$ ctr images import` ã‚’å®Ÿè¡Œã—ã¦ã€container image ã‚’ import ã™ã‚‹ã€äº‹ã§å®Ÿç¾ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚é¢ç™½ã„ã§ã™ã­ï¼
